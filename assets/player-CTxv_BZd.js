import{s as c}from"./client-CGC07Of8.js";import{c as ce,r as de}from"./playlist-DU85hsid.js";import"./auth-D4SaOFKr.js";import"https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";console.log("App.js loaded");console.log("Supabase instance:",c?"Connected":"Not connected");console.log("Script loaded:",window.location.href);let d=null,h=!1,T=0,m=[],v=.5,y=!1,A="off",$=[],q=null,B=null,S=null,C=null,k=null,b=null,F=!1,I=!1,N=!1;window.isPlaying=h;window.currentUser=window.currentUser||null;window.appFunctions=window.appFunctions||{};const ue="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR4nGNgYAAAAAMAASsJTYQAAAAASUVORK5CYII=";console.log("FALLBACK_COVER data-uri in use (no network request):",ue);window.currentPlaylists=window.currentPlaylists||{};async function pe(e){var n,o;const t=(n=e==null?void 0:e.detail)==null?void 0:n.session;if(console.log("SUPABASE_SESSION_RESTORED received in app.js:",!!(t!=null&&t.user),((o=t==null?void 0:t.user)==null?void 0:o.email)??null),t!=null&&t.user){window.currentUser=t.user;try{!window.appInitialized&&!window.initializationInProgress?(await L(t.user),window.appInitialized=!0):console.log("App already initialized or in progress; skipping initializeApp")}catch(r){console.error("Error initializing app after session restored:",r)}}else if(console.warn("No session after restore - redirecting to login if on protected page"),window.location.pathname.includes("player.html")){const r=window.location.origin+"/manh-music/index.html";console.log("Redirecting to login:",r),window.location.href=r}}window.addEventListener("SUPABASE_SESSION_RESTORED",pe);window.addEventListener("SUPABASE_AUTH_CHANGE",async e=>{var o;const{event:t,session:n}=e.detail||{};console.log("SUPABASE_AUTH_CHANGE in app.js:",t,((o=n==null?void 0:n.user)==null?void 0:o.email)??null),t==="SIGNED_IN"&&(n!=null&&n.user)?(window.currentUser=n.user,await L(n.user),window.appInitialized=!0):t==="SIGNED_OUT"&&(E==null||E())});window.addEventListener("load",()=>{!window.currentUser&&window.supabase&&(console.log("üîÑ App.js load fallback: Checking session"),window.supabase.auth.getUser().then(({data:{user:e}})=>{e&&!window.currentUser&&(window.currentUser=e,console.log("‚úÖ App.js fallback user set:",e.id),L(e))}))});window.addEventListener("beforeunload",()=>{q=null,B=null,S=null,C=null,k=null,b=null,window.playlistsLoadFlag=!1,console.log("üîÑ Cache reset for new tab")});function J(){document.getElementById("playPauseBtn").addEventListener("click",x),document.getElementById("prevBtn").addEventListener("click",playPreviousTrack),document.getElementById("nextBtn").addEventListener("click",playNextTrack);const e=document.getElementById("volumeSlider");e&&e.addEventListener("input",we),e&&(e.value=v*100),document.getElementById("progressBar").addEventListener("input",fe),document.getElementById("shuffleBtn").addEventListener("click",Ae),document.getElementById("repeatBtn").addEventListener("click",Le),document.addEventListener("keydown",ge),console.log("Player controls initialized")}window.initializePlayerControls=J;window.closeModal=function(e){const t=document.getElementById(e);t?(t.style.display="none",console.log(`Modal ${e} closed.`)):console.warn(`Attempted to close non-existent modal: ${e}`)};window.addEventListener("error",function(e){console.error("üõë Global Error:",e.error),console.error("üõë Error at:",e.filename,"line:",e.lineno),e.error instanceof SyntaxError&&(console.warn("üîÑ Syntax error detected, attempting recovery..."),sessionStorage.clear())});if(window.location.hostname==="localhost"){const e="?v="+Date.now();document.querySelectorAll('script[type="module"][src*="/scripts/"]').forEach(t=>{t.src.includes("?")||(t.src+=e)})}c.auth.getSession().then(({data:{session:e},error:t})=>{window.currentUser||(console.log("üîÑ App.js: Force retry getSession after 500ms"),setTimeout(()=>{c.auth.getSession().then(({data:{session:n},error:o})=>{var r;console.log("üîÑ Force getSession result:",!!(n!=null&&n.user),((r=n==null?void 0:n.user)==null?void 0:r.email)||"null"),n!=null&&n.user&&!window.currentUser?(window.currentUser=n.user,console.log("‚úÖ App.js force session restored:",n.user.email),document.readyState==="complete"&&typeof L=="function"&&L(n.user)):o&&(console.error("Force getSession error:",o),localStorage.removeItem("sb-lezswjtnlsmznkgrzgmu-auth-token"))})},500))}).catch(e=>console.error("Force getSession failed:",e));function x(){if(console.log("üéµ togglePlayPause called, current state:",{isPlaying:h,hasAudio:!!d,isTransitioning:I}),I){console.log("‚è≥ Skipping - transition in progress");return}I=!0,setTimeout(()=>{I=!1},300);const e=document.getElementById("playPauseBtn");if(!d){console.log("‚ùå No audio element - cannot play"),m.length>0&&(console.log("üîÑ Attempting to play first track from playlist"),playTrack(m[T])),I=!1;return}const t=e?e.querySelector("i"):null;try{h?(console.log("‚è∏Ô∏è Pausing audio"),d.pause(),N=!0,setTimeout(()=>{N=!1},500),t&&(t.className="fas fa-play"),h=!1):(console.log("‚ñ∂Ô∏è Playing audio"),d.play().then(()=>{console.log("‚úÖ Play successful"),d.track&&window.updatePlayerBar(d.track),O()}).catch(n=>{if(console.error("‚ùå Play failed:",n),n&&n.name==="NotAllowedError"){console.warn("Autoplay blocked by browser policy; automatic play aborted.");return}if(n.name==="AbortError"||n.message.includes("interrupted by a call to pause()")||N){console.warn("‚ö†Ô∏è Play interrupted - ignoring");return}console.log("üîÑ Attempting to reload audio"),d.load(),setTimeout(()=>{d.play().catch(o=>{console.error("‚ùå Final play attempt failed:",o),alert("Kh√¥ng th·ªÉ ph√°t nh·∫°c: "+o.message)})},100)}),t&&(t.className="fas fa-pause"),h=!0)}catch(n){console.error("‚ùå Error in togglePlayPause:",n),h=!1,t&&(t.className="fas fa-play")}}window.togglePlayPause=x;function we(e){v=e.target.value/100,d&&(d.volume=v)}window.showPlayGestureOverlay=function(e){console.debug("showPlayGestureOverlay called but is disabled in this build.")};function fe(e){if(d&&d.duration){const t=e.target.value/100*d.duration;d.currentTime=t}}function ge(e){if(e.target.tagName!=="INPUT")switch(e.code){case"Space":e.preventDefault(),x();break;case"ArrowLeft":e.preventDefault(),j(-10);break;case"ArrowRight":e.preventDefault(),j(10);break;case"ArrowUp":e.preventDefault(),me();break;case"ArrowDown":e.preventDefault(),he();break}}function j(e){d&&(d.currentTime+=e)}function me(){v=Math.min(1,v+.1),d&&(d.volume=v);const e=document.getElementById("volumeSlider");e&&(e.value=v*100)}function he(){v=Math.max(0,v-.1),d&&(d.volume=v);const e=document.getElementById("volumeSlider");e&&(e.value=v*100)}function O(){const e=document.getElementById("progressBar"),t=document.getElementById("currentTime"),n=document.getElementById("duration");if(d&&e){const o=d.currentTime/d.duration*100||0;e.value=o,t&&(t.textContent=W(d.currentTime)),n&&isFinite(d.duration)&&(n.textContent=W(d.duration))}}async function U(e,t=!1){const n="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR4nGNgYAAAAAMAASsJTYQAAAAASUVORK5CYII=",o=document.getElementById("userName"),r=document.getElementById("userAvatar"),a=document.getElementById("currentAvatarPreview");let i=await z(e.id);const l=(i==null?void 0:i.username)||"User Name";o&&(o.textContent=l);let s=n;if(i!=null&&i.avatar_url)if(i.avatar_url.includes("supabase.co")||i.avatar_url.startsWith("http"))s=i.avatar_url;else{const{data:w}=c.storage.from("avatars").getPublicUrl(i.avatar_url);w!=null&&w.publicUrl&&(s=w.publicUrl)}r&&(r.src=s),a&&(a.src=s);const u=document.getElementById("editUsername");u&&i&&(u.value=i.username||"");const p=document.getElementById("editBirthday");p&&i&&(p.value=i.birthday||"")}async function z(e){if(C)return C;const{data:t,error:n}=await c.from("users").select("username, birthday, avatar_url").eq("id",e).single();if(n)throw n;return C=t,t}window.loadProfile=z;function ye(e){if(!e)return"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR4nGNgYAAAAAMAASsJTYQAAAAASUVORK5CYII=";if(e.includes("supabase.co")||e.startsWith("http"))return e;const{data:t}=c.storage.from("avatars").getPublicUrl(e);return(t==null?void 0:t.publicUrl)||"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR4nGNgYAAAAAMAASsJTYQAAAAASUVORK5CYII="}async function ve(e,t){const n="avatars",o=t.name.split(".").pop(),r=`${e}/${Date.now()}_avatar.${o}`;try{console.log("Starting avatar upload to path:",r);const{data:a,error:i}=await c.storage.from(n).upload(r,t,{cacheControl:"3600",upsert:!0});if(i)return console.error("Upload error:",i),null;console.log("Upload data:",a);const{data:l}=c.storage.from(n).getPublicUrl(r);return console.log("Public URL:",l.publicUrl),l.publicUrl}catch(a){return console.error("System error during upload:",a),null}}function W(e){if(!e||isNaN(e))return"0:00";const t=Math.floor(e/60),n=Math.floor(e%60);return`${t}:${n.toString().padStart(2,"0")}`}window.playTrack=async function(e,t=m,n=-1){if(console.log("üéµ Attempting to play track:",e),!e||!e.file_url){console.error("‚ùå L·ªói: Th√¥ng tin track kh√¥ng h·ª£p l·ªá ho·∫∑c thi·∫øu file_url."),console.log("Track data:",e),alert("Kh√¥ng th·ªÉ ph√°t b√†i h√°t: File kh√¥ng t·ªìn t·∫°i");return}console.log("üìã Track details:",{title:e.title,artist:e.artist,file_url:e.file_url,has_file_url:!!e.file_url}),d&&(console.log("‚è∏Ô∏è Stopping previous audio"),d.pause(),d=null),t&&t.length>0&&(m=t,T=n!==-1?n:m.findIndex(r=>r.id===e.id)||0,y&&K());let o=e.file_url;console.log("üîó Original audio URL:",o),o&&o.includes("supabase.co")&&(o.includes("?")||(o+="?"),o+=`&t=${Date.now()}`,console.log("üîß Fixed Supabase URL:",o));try{try{const a=(await fetch(o,{method:"HEAD"})).headers.get("content-type")||"";if(console.log("üîé HEAD content-type for audioUrl:",a),a.includes("text/html")){console.error("‚ùå Audio URL points to HTML (likely a page), aborting play:",o),alert("Kh√¥ng th·ªÉ ph√°t b√†i h√°t: file tr·∫£ v·ªÅ HTML thay v√¨ file √¢m thanh. Ki·ªÉm tra file_url.");return}}catch(r){console.warn("‚ö†Ô∏è HEAD request failed, attempting range GET to probe content-type",r);try{const i=(await fetch(o,{method:"GET",headers:{Range:"bytes=0-1023"}})).headers.get("content-type")||"";if(console.log("üîé Range GET content-type for audioUrl:",i),i.includes("text/html")){console.error("‚ùå Audio URL points to HTML (via range GET), aborting play:",o),alert("Kh√¥ng th·ªÉ ph√°t b√†i h√°t: file tr·∫£ v·ªÅ HTML thay v√¨ file √¢m thanh. Ki·ªÉm tra file_url.");return}}catch(a){console.warn("‚ö†Ô∏è Probe request failed, continuing to create Audio (last resort)",a)}}d=new Audio(o),d.track=e,d.volume=v,d.preload="metadata",console.log("üéµ Audio element created"),d.addEventListener("loadeddata",function(){console.log("‚úÖ Audio loaded successfully:",e.title),O()}),d.addEventListener("canplay",function(){console.log("üé∂ Audio ready to play")}),d.addEventListener("error",function(r){console.error("‚ùå Audio load error:",r),console.error("Error details:",{error:d.error,networkState:d.networkState,readyState:d.readyState});let a="L·ªói t·∫£i file nh·∫°c: ";switch(d.error.code){case MediaError.MEDIA_ERR_ABORTED:a+="T·∫£i b·ªã h·ªßy";break;case MediaError.MEDIA_ERR_NETWORK:a+="L·ªói m·∫°ng";break;case MediaError.MEDIA_ERR_DECODE:a+="L·ªói ƒë·ªãnh d·∫°ng file";break;case MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED:a+="ƒê·ªãnh d·∫°ng kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£";break;default:a+="L·ªói kh√¥ng x√°c ƒë·ªãnh"}alert(a),d=null,h=!1}),d.addEventListener("timeupdate",O),d.addEventListener("ended",function(){console.log("‚èπÔ∏è Track ended:",e.title),h=!1;const r=document.getElementById("playPauseBtn"),a=r?r.querySelector("i"):null;a&&(a.className="fas fa-play"),m.length>0&&setTimeout(window.playNextTrack,500)}),d.load(),setTimeout(()=>{X(d,e)},100)}catch(r){console.error("‚ùå L·ªói t·∫°o audio element:",r),alert("L·ªói kh·ªüi t·∫°o tr√¨nh ph√°t nh·∫°c: "+r.message),d=null,h=!1}};window.playTrack=playTrack;async function X(e,t,n=0){try{console.log(`üéµ Attempting to play (retry ${n})...`),await e.play(),h=!0,window.updatePlayerBar(t);const r=document.getElementById("playPauseBtn"),a=r?r.querySelector("i"):null;a&&(a.className="fas fa-pause"),console.log("üé∂ Now playing:",t.title,"by",t.artist),ke(t.id),typeof window.fetchLyrics=="function"&&window.fetchLyrics(t)}catch(r){if(console.error(`‚ùå Play failed (attempt ${n+1}):`,r),r&&r.name==="NotAllowedError"){console.warn("Autoplay blocked by browser - prompting user gesture"),window.showPlayGestureOverlay(async()=>{try{await e.play()}catch(a){console.error("Play after user gesture failed:",a),alert("Kh√¥ng th·ªÉ ph√°t b√†i h√°t sau khi y√™u c·∫ßu t∆∞∆°ng t√°c: "+(a.message||a))}});return}n<2?(console.log(`üîÑ Retrying play... (${n+1}/2)`),setTimeout(()=>X(e,t,n+1),500)):(console.error("‚ùå Max play retries exceeded"),alert("Kh√¥ng th·ªÉ ph√°t b√†i h√°t. C√≥ th·ªÉ file b·ªã l·ªói ho·∫∑c ƒë·ªãnh d·∫°ng kh√¥ng h·ªó tr·ª£."),h=!1,d=null)}}window.playNextTrack=async function(){if(A==="one"){window.appFunctions.playTrack(m[T]);return}if(m.length===0){if(console.log("No current playlist - loading recommendations for random next"),!window.currentUser)return;if(!S||S.length===0)try{const{data:i,error:l}=await c.rpc("get_unique_recommendations",{limit_count:20});if(l)throw l;S=i||[]}catch(i){console.error("L·ªói load recommendations for random:",i),h=!1;return}const o=S;if(o.length===0){console.log("No recommendations available - stopping playback"),h=!1;return}y||(y=!0,K(),console.log("Auto-enabled shuffle for recs fallback"));const r=Math.floor(Math.random()*o.length);m=o,T=r;const a=o[r];console.log(`Auto-playing random recommendation: ${a.title} (shuffled mode)`),window.appFunctions.playTrack(a);return}let e;if(y){let n=$.indexOf(T);n=(n+1)%m.length,e=$[n]}else e=(T+1)%m.length,$=[];T=e;const t=m[e];window.appFunctions.playTrack(t),setTimeout(()=>{const n=document.getElementById("playPauseBtn"),o=n?n.querySelector("i"):null;h&&o&&(o.className="fas fa-pause")},100)};window.playPreviousTrack=function(){if(m.length===0)return;T=(T-1+m.length)%m.length;const e=m[T];window.appFunctions.playTrack(e)};function _(e){if(!e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}async function ke(e){var r;const t=window.currentUser;if(!t||!e)return;const n=t.id,o=new Date().toISOString();try{const{data:a,error:i}=await c.from("history").select("play_count").eq("user_id",n).eq("track_id",e).maybeSingle();if(i){console.error("L·ªói select history:",i);return}const l=((a==null?void 0:a.play_count)||0)+1,{error:s}=await c.from("history").upsert({user_id:n,track_id:e,play_count:l,played_at:o},{onConflict:"user_id,track_id"});if(s){console.error("L·ªói upsert history:",s);return}console.log(`History updated: ${l} l·∫ßn ph√°t cho track ${e}`),((r=document.getElementById("home-section"))==null?void 0:r.style.display)!=="none"&&setTimeout(()=>{var u;(u=window.renderPlayHistory)==null||u.call(window)},500)}catch(a){console.error("L·ªói h·ªá th·ªëng update history:",a)}}window.renderPlayHistory=async function(){await _e()};async function Z(e=!1){if(console.log("1. loadUserPlaylists STARTED",{forceRefresh:e}),!e&&window.playlistsLoadFlag){console.log("2. SKIP: already loaded");return}window.playlistsLoadFlag=!0;const t=window.currentUser;if(console.log("3. Using window.currentUser:",t?t.id:"NULL"),!t){console.error("5. NO USER ‚Üí STOPPING loadUserPlaylists"),window.playlistsLoadFlag=!1;return}const n=document.getElementById("playlistGrid");if(!n){console.error("7. playlistGrid NOT FOUND"),window.playlistsLoadFlag=!1;return}try{console.log("8. QUERYING playlists table...");const{data:o,error:r}=await te(()=>c.from("playlists").select("id, name, icon, color, cover_url").eq("user_id",t.id).order("created_at",{ascending:!1}));if(r)throw r;q=o||[],de(o,n),console.log("11. renderPlaylists DONE")}catch(o){console.error("12. FINAL ERROR:",o),n.innerHTML='<p class="error-message">L·ªói t·∫£i playlist.</p>'}finally{window.playlistsLoadFlag=!1,console.log("13. loadUserPlaylists FINISHED")}}window.appFunctions.loadUserPlaylists=window.loadUserPlaylists;window.renderRecentHistory=async function(){const e=document.getElementById("historyTrackList");if(!e)return;const t=window.currentUser;if(!t){e.innerHTML='<p class="empty-message">Vui l√≤ng ƒëƒÉng nh·∫≠p.</p>';return}const n=window.getAssetUrl("assets/default-cover.webp");try{const{data:o,error:r}=await c.from("history").select(`
                track_id,
                played_at,
                tracks (
                    id, title, artist, cover_url, file_url
                )
            `).eq("user_id",t.id).order("played_at",{ascending:!1}).limit(5);if(r)throw r;if(!o||o.length===0){e.innerHTML='<p class="empty-message">Ch∆∞a c√≥ b√†i h√°t n√†o ƒë∆∞·ª£c ph√°t g·∫ßn ƒë√¢y.</p>';return}e.innerHTML=o.map((a,i)=>`
            <div class="track-item playable-track" onclick='event.stopPropagation(); window.playTrack(${JSON.stringify(a.tracks)}, [], -1)'>
                <div class="track-info">
                    <span class="track-index">${i+1}</span>
                    <img src="${a.tracks.cover_url||n}" 
                        class="track-cover" onerror="if(!this._tried){this._tried=true;this.src='${n}';}">
                    <div class="track-details">
                        <div class="track-name">${_(a.tracks.title)}</div>
                        <div class="track-artist">${_(a.tracks.artist)}</div>
                    </div>
                </div>
                <div class="track-actions">
                    <button class="btn-action" onclick="event.stopPropagation(); window.appFunctions.togglePlaylistDropdown(this, '${a.tracks.id}')">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
        `).join("")}catch(o){console.error("L·ªói t·∫£i l·ªãch s·ª≠ g·∫ßn ƒë√¢y:",o),e.innerHTML='<p class="error-message">L·ªói t·∫£i l·ªãch s·ª≠.</p>'}};window.loadTopTracks=async function(e=10){try{const{data:t,error:n}=await c.from("history").select(`
                track_id,
                play_count,
                tracks (
                    id,
                    title,
                    artist,
                    cover_url,
                    file_url
                )
            `).order("play_count",{ascending:!1}).limit(e);if(n)throw n;return t.sort((r,a)=>(a.play_count||0)-(r.play_count||0)).slice(0,e).map(r=>({...r.tracks,play_count:r.play_count||0}))}catch(t){return console.error("L·ªói t·∫£i top tracks:",t),[]}};window.renderRecommendations=async function(){const e=document.getElementById("recommendList");if(!e)return;e.innerHTML="<p>ƒêang t·∫£i g·ª£i √Ω...</p>";const t=await window.loadTopTracks(10),n=window.getAssetUrl("assets/default-cover.webp");if(t.length===0){e.innerHTML='<p class="empty-message">Ch∆∞a c√≥ g·ª£i √Ω.</p>';return}e.innerHTML=t.map((o,r)=>`
        <div class="track-item playable-track" onclick='event.stopPropagation(); window.playTrack(${JSON.stringify(o)}, [], -1)'>
            <div class="track-info">
                <span class="track-index">${r+1}</span>
                <img src="${o.cover_url||n}" class="track-cover" onerror="if(!this._tried){this._tried=true;this.src='${n}';}">
                <div class="track-details">
                    <div class="track-name">${_(o.title)}</div>
                    <div class="track-artist">${_(o.artist)}</div>
                </div>
            </div>
            <div class="track-actions">
                <button class="btn-action" onclick="event.stopPropagation(); window.togglePlaylistDropdown(this, '${o.id}')">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </div>
    `).join("")};function ee(e){window.switchTab?window.switchTab("detail-playlist",e):console.error("Kh√¥ng t√¨m th·∫•y h√†m switchTab.")}window.appFunctions.openPlaylistDetail=ee;window.handleCreatePlaylistSubmit=async function(e){var s;e.preventDefault();const t=e.target,n=t.querySelector("#playlistName"),o=t.querySelector("#playlistColor"),r=n?n.value.trim():null,a=o?o.value:"#1db954",i=(s=t.querySelector("#playlistCoverFile"))==null?void 0:s.files[0];if(!r){alert("T√™n danh s√°ch ph√°t kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.");return}const l=window.currentUser;if(!l){alert("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ t·∫°o danh s√°ch ph√°t!");return}try{const p=await ce({name:r,color:a,cover_url:null});if(console.log("Playlist created:",p),i&&(p!=null&&p.id)){const f=await uploadPlaylistCover(l.id,p.id,i);if(f){const{error:g}=await c.from("playlists").update({cover_url:f}).eq("id",p.id);g&&console.error("L·ªói c·∫≠p nh·∫≠t cover_url:",g)}}closeModal("createPlaylistModal"),window.cachedPlaylists=null,await window.appFunctions.loadUserPlaylists(!0);const w=localStorage.getItem("pendingTrackId");w&&(p!=null&&p.id)&&(await window.appFunctions.addTrackToPlaylist(w,p.id),localStorage.removeItem("pendingTrackId"))}catch(u){console.error("L·ªñI t·∫°o playlist:",u),alert("ƒê√£ x·∫£y ra l·ªói: "+u.message)}};window.handleCreatePlaylistSubmit=handleCreatePlaylistSubmit;function Ae(){y=!y;const e=document.getElementById("shuffleBtn");e&&e.classList.toggle("active",y),Te(),console.log("Shuffle mode:",y?"ON":"OFF"),y&&m.length>1&&K()}function Te(){const e=document.getElementById("shuffleBtn");e&&(e.setAttribute("data-state",y?"on":"off"),e.style.color=y?"var(--primary-color)":"inherit")}function K(){const e=Array.from({length:m.length},(t,n)=>n);for(let t=e.length-1;t>0;t--){const n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}$=e}function Le(){A==="off"?A="all":A==="all"?A="one":A="off";const e=document.getElementById("repeatBtn");e&&e.classList.toggle("active",A!=="off"),Y(),Y(),console.log("Repeat mode:",A)}function Y(){const e=document.getElementById("repeatBtn");e&&(e.setAttribute("data-mode",A),e.style.color=A!=="off"?"var(--primary-color)":"inherit")}window.deleteTrack=async function(e){if(confirm("X√≥a b√†i h√°t n√†y? Kh√¥ng th·ªÉ kh√¥i ph·ª•c!"))try{const{error:t}=await c.from("playlist_tracks").delete().eq("track_id",e);if(t)throw t;const{error:n}=await c.from("tracks").delete().eq("id",e);if(n)throw n;alert("ƒê√£ x√≥a b√†i h√°t!"),window.loadMyUploads(!0)}catch(t){console.error("L·ªói x√≥a:",t),alert("L·ªói: "+t.message)}};window.appFunctions.deleteTrack=window.deleteTrack;async function te(e,t=3,n=1e3){let o;for(let r=1;r<=t;r++)try{console.log(`Attempt ${r}/${t}`);const a=await e();if(a.error){if(console.error("Query returned error object:",a.error),a.error.code!=="PGRST116")throw a.error;return console.log("No rows found (PGRST116) - returning empty"),{data:null,error:null}}return console.log(`Query succeeded on attempt ${r}`),a}catch(a){if(o=a,console.warn(`Attempt ${r} failed:`,a),a!=null&&a.response&&console.warn("Response object:",a.response),r<t){const i=n*Math.pow(2,r-1);console.log(`Retrying in ${i}ms...`),await new Promise(l=>setTimeout(l,i))}}throw console.error("All retry attempts failed:",o),o}async function Ee(){console.log("üß™ Testing Supabase connection...");const e=[{name:"Authentication",test:async()=>{if(!window.currentUser)throw new Error("No user logged in");return window.currentUser}},{name:"Database Read",test:async()=>{const o=await c.from("tracks").select("id").limit(1);if(o.error&&o.error.code!=="PGRST116")throw o.error;return o}},{name:"Storage Access",test:async()=>{const o=await c.storage.from("music-files").list("",{limit:1});if(o.error)throw o.error;return o}}],t=[];for(const o of e)try{const r=performance.now(),a=await o.test();console.log(`${o.name} raw result:`,a);const l=(performance.now()-r).toFixed(0);t.push({name:o.name,status:"‚úÖ",time:`${l}ms`}),console.log(`‚úÖ ${o.name}: ${l}ms`)}catch(r){t.push({name:o.name,status:"‚ùå",error:r.message}),console.error(`‚ùå ${o.name} failed:`,r.message)}return console.table(t),t.filter(o=>o.status==="‚ùå").length===0}function D(){const e=document.createElement("div");e.id="connectionWarning",e.innerHTML=`
        <div style="position: fixed; top: 10px; right: 10px; background: #ff6b6b; color: white; padding: 10px; border-radius: 5px; z-index: 10000; max-width: 300px;">
            <strong>‚ö†Ô∏è K·∫øt n·ªëi kh√¥ng ·ªïn ƒë·ªãnh</strong>
            <p style="margin: 5px 0; font-size: 12px;">M·ªôt s·ªë t√≠nh nƒÉng c√≥ th·ªÉ kh√¥ng ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng.</p>
            <button onclick="this.parentElement.remove()" style="background: white; border: none; padding: 2px 8px; border-radius: 3px; cursor: pointer;">ƒê√≥ng</button>
        </div>
    `,document.body.appendChild(e),setTimeout(()=>{e.parentElement&&e.remove()},1e4)}window.appFunctions={...window.appFunctions,loadAndOpenProfileModal:be,initializePlayerControls:J,navigateTo:ie,initProfileModal:ae,handleProfileSubmit:R,handleLogout:window.handleLogout,togglePlayPause:x,playTrack:window.playTrack,loadUserPlaylists:Z,loadHistoryTracks:Pe,playNextTrack:window.playNextTrack,playPreviousTrack:window.playPreviousTrack,searchTracks:window.searchTracks,loadMyUploads:window.loadMyUploads,loadPlaylistTracks:window.loadPlaylistTracks,openPlaylistDetail:ee,togglePlaylistDropdown:window.togglePlaylistDropdown,deleteTrack:window.deleteTrack,addTrackToPlaylist:window.appFunctions.addTrackToPlaylist,createNewPlaylist:window.appFunctions.createNewPlaylist,closeModal:window.closeModal,getCurrentUserId:ne,getBaseUrl:H};window.loadPlaylistTracks=async function(e,t=!1){if(!window.currentUser)return console.error("User kh√¥ng ƒëƒÉng nh·∫≠p, kh√¥ng t·∫£i tracks."),[];if(k&&k[e])return k[e];try{const{data:o,error:r}=await c.from("playlist_tracks").select("track_id, added_at").eq("playlist_id",e).order("added_at",{ascending:!0});if(r)throw console.error("L·ªói fetch playlist_items:",r),r;if(o.length===0){console.log(`Playlist ${e} tr·ªëng - no items.`);const u=[];return k||(k={}),k[e]=u,window.currentPlaylistSource="Playlist ID "+e,u}const a=o.map(u=>u.track_id),{data:i,error:l}=await c.from("tracks").select("id, title, artist, file_url, cover_url, user_id").in("id",a);if(l)throw console.error("L·ªói fetch tracks by IDs:",l),l;const s=i.map(u=>{const p=o.find(w=>w.track_id===u.id);return{...u,added_at:p?p.added_at:null}}).sort((u,p)=>{const w=new Date(u.added_at||0).getTime(),f=new Date(p.added_at||0).getTime();return w-f});return k||(k={}),k[e]=s,window.currentPlaylistSource="Playlist ID "+e,console.log(`T·∫£i ${s.length} tracks t·ª´ playlist ${e}:`,s.map(u=>u.title)),t&&s.length>0&&window.playTrack(s[0],s,0),s}catch(o){return console.error("L·ªói t·∫£i tracks playlist:",o),o.details&&console.log("Relationship details:",o.details),[]}};window.appFunctions.loadPlaylistTracks=window.loadPlaylistTracks;async function oe(){const e=window.currentUser;if(!e){console.warn("‚è≥ B·ªè qua testRLS ‚Äì ch∆∞a c√≥ user");return}console.log("üß™ Testing RLS Policies for user:",e.id);try{const{error:t}=await c.from("tracks").select("*").limit(1);console.log("Tracks SELECT:",t?+t.message:"‚úÖ OK");const{error:n}=await c.from("users").select("*").eq("id",e.id).single();console.log("Users SELECT:",n?+n.message:"‚úÖ OK")}catch(t){console.error("L·ªói testRLS:",t)}}async function ne(){const e=window.currentUser;return e==null?void 0:e.id}window.appFunctions.getCurrentUserId=ne;window.displayTracks=function(e,t){if(!t)return;t.innerHTML="";const n=window.getAssetUrl("assets/default-cover.webp"),o=t.id;e.forEach((r,a)=>{const i=document.createElement("div");i.className="track-item playable-track",i.trackData=r,i.addEventListener("click",function(g){g.target.closest(".btn-action")||(i.trackData&&window.appFunctions.playTrack&&(window.currentPlaylist=e,window.currentTrackIndex=a,window.appFunctions.playTrack(i.trackData,e,a)),g.preventDefault())});const l=(r.title||"").trim()||"B√†i h√°t kh√¥ng t√™n",s=(r.artist||"").trim()||"Ngh·ªá sƒ© kh√¥ng r√µ",u=l.length>15?`${l} ${l}`:l,p=s.length>15?`${s} ${s}`:s;console.log(`Display track ${a} (${o}):`,{id:r.id,title:r.title,artist:r.artist}),i.innerHTML=`
            <div class="track-index">${a+1}.</div>
            <img src="${r.cover_url||n}" 
                alt="${l} by ${s}" 
                class="track-cover" 
                onerror="if(!this._tried){this._tried=true;this.src='${n}';}" />
            <div class="track-info">
                <div class="track-details">
                    <strong class="track-name marquee-container">
                        <span class="track-title-inner">${u}</span>
                    </strong>
                    <small class="track-artist marquee-container">
                        <span class="track-artist-text">${p}</span>
                    </small>
                </div>
            </div>
          
            <div class="track-actions">
                <div class="playlist-add-container">
                    <button
                        class="btn-action btn-add-playlist"
                        data-track-id="${r.id}"
                        title="Th√™m v√†o playlist">
                        <i class="fa-solid fa-plus"></i>
                    </button>
                    <div class="playlist-dropdown" data-track-id="${r.id}">
                    </div>
                </div>
                ${o==="myUploadsList"?`
                    <button class="btn-action btn-delete-track"
                            onclick="event.stopPropagation(); window.appFunctions.deleteTrack('${r.id}')">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                `:""}
            </div>
        `;const w=i.querySelector(".track-name.marquee-container");if(w){const g=w.querySelector(".track-title-inner");g&&g.scrollWidth>w.clientWidth&&g.classList.add("marquee")}const f=i.querySelector(".track-artist.marquee-container");if(f){const g=f.querySelector(".track-artist-text");g&&g.scrollWidth>f.clientWidth&&g.classList.add("marquee")}t.appendChild(i)}),t.dataset.delegationAttached||(t.addEventListener("click",function(r){const a=r.target.closest(".btn-add-playlist");if(a){r.stopPropagation(),r.stopImmediatePropagation();const i=a.dataset.trackId;if(i){window.dropdownDebounce||(window.dropdownDebounce={});const l=`toggle_${i}`;if(window.dropdownDebounce[l])return;window.dropdownDebounce[l]=!0,setTimeout(()=>{delete window.dropdownDebounce[l]},200),console.log("Toggle dropdown cho track (delegated):",i),window.appFunctions.togglePlaylistDropdown(a,i)}}}),t.dataset.delegationAttached="true",console.log(`Event delegation attached for container ${o}`)),console.log(`Displayed ${e.length} tracks in ${o} - Check console for data`)};async function re(e){const t=document.getElementById("searchList");if(!t)return;if(!e||e.length<3){t.innerHTML='<p class="empty-message">Nh·∫≠p t·ª´ kh√≥a ƒë·ªÉ b·∫Øt ƒë·∫ßu t√¨m ki·∫øm.</p>';return}let n=c.from("tracks").select(`
            id, 
            title, 
            artist, 
            file_url,
            cover_url,
            users!user_id (username)
        `);n=n.or(`title.ilike.%${e}%,artist.ilike.%${e}%`);const{data:o,error:r}=await n.limit(10);if(r){console.error("L·ªói t√¨m ki·∫øm:",r),t.innerHTML=`<p class="error-message">L·ªói khi t√¨m ki·∫øm: ${r.message}</p>`;return}window.displayTracks(o,t)}window.searchTracks=re;window.appFunctions.searchTracks=re;async function ae(){const e=window.currentUser;if(!e){console.log("No user logged in");return}console.log("Fetching profile for user ID:",e.id);let{data:t,error:n}=await c.from("users").select("username, birthday, avatar_url").eq("id",e.id).single();if(n)if(console.error("Select error:",n),alert("L·ªói select profile: "+n.message+" (Check RLS for SELECT policy)"),n.code==="PGRST116"){console.log("No profile - inserting default");const s=e.email?e.email.split("@")[0]:"New User",{data:u,error:p}=await c.from("users").insert([{id:e.id,email:e.email||"noemail@example.com",username:s,birthday:null,avatar_url:null,updated_at:new Date().toISOString()}]).select("username, birthday, avatar_url").single();if(p){console.error("Insert error:",p),alert("L·ªói insert profile: "+p.message+" (Check RLS for INSERT policy)");return}t=u}else return;console.log("Profile data:",t),document.getElementById("editEmail").value=e.email||"Ch∆∞a c√≥ email";let r=t.avatar_url?ye(t.avatar_url):"assets/default-avatar.png",a=t.username||(e.email?e.email.split("@")[0]:"User Name"),i=t.birthday||"";document.getElementById("editUsername").value=a,document.getElementById("editBirthday").value=i;const l=document.getElementById("currentAvatarPreview");l&&(l.src=r),window.cachedProfile=t,U(e)}window.initProfileModal=ae;async function R(e){e.preventDefault(),console.log("Form submit triggered");const t=document.getElementById("saveProfileBtn"),n=window.currentUser;if(!n)return;const o=document.getElementById("editUsername").value.trim(),r=document.getElementById("editBirthday").value||null,a=document.getElementById("avatarFile").files[0];if(!o){alert("T√™n ng∆∞·ªùi d√πng b·∫Øt bu·ªôc!");return}if(r&&isNaN(Date.parse(r))){alert("Ng√†y sinh format sai!");return}const i=await z(n.id);let l=(i==null?void 0:i.avatar_url)||null;if(t.textContent="ƒêang l∆∞u...",t.disabled=!0,a){const g=await ve(n.id,a);if(!g){alert("L·ªói upload avatar - check console"),t.textContent="L∆∞u Thay ƒê·ªïi",t.disabled=!1;return}l=g}const s={email:n.email||"noemail@example.com",username:o,birthday:r,avatar_url:l||null};console.log("Preparing save with:",s);const{count:u,error:p}=await c.from("users").select("count",{count:"exact"}).eq("id",n.id);if(p){console.error("Count error:",p),alert("L·ªói check profile: "+p.message+" (Check RLS for SELECT)"),t.textContent="L∆∞u Thay ƒê·ªïi",t.disabled=!1;return}let w,f;if(u>0?(console.log("Row exists - updating"),{data:w,error:f}=await c.from("users").update(s).eq("id",n.id).select()):(console.log("No row - inserting"),{data:w,error:f}=await c.from("users").insert([{id:n.id,...s}]).select()),f){console.error("Save error:",f),alert("L·ªói save: "+f.message+" (Check RLS for UPDATE/INSERT)"),t.textContent="L∆∞u Thay ƒê·ªïi",t.disabled=!1;return}w.length>0?(console.log("Save success, returned data:",w),alert("L∆∞u th√†nh c√¥ng!")):(console.log("Save no row affected"),alert("Kh√¥ng c√≥ thay ƒë·ªïi (RLS may block or values same)")),window.cachedProfile=null,U(n,!0),t.textContent="L∆∞u Thay ƒê·ªïi",t.disabled=!1,closeModal("profileModal")}async function be(){const e=document.getElementById("profileModal"),t=document.getElementById("modalContentContainer");if(window.cachedProfile=null,!t||!e){console.error("Kh√¥ng t√¨m th·∫•y Modal ho·∫∑c Container.");return}const n='<div style="padding: 20px; text-align: center;">ƒêang t·∫£i th√¥ng tin c√° nh√¢n...</div>';if(t.innerHTML=n,e.style.display="flex",t.innerHTML===n)try{const r=await fetch("/profile.html");if(!r.ok)throw new Error("Kh√¥ng th·ªÉ t·∫£i profile.html");t.innerHTML=await r.text();const a=document.getElementById("profileEditForm");a&&typeof R=="function"?(a.removeEventListener("submit",R),a.addEventListener("submit",R),console.log("Submit listener attached successfully to profileEditForm")):console.error('L·ªói: Kh√¥ng t√¨m th·∫•y form ID="profileEditForm" ho·∫∑c h√†m handleProfileSubmit.');const i=document.getElementById("avatarFile");i&&i.addEventListener("change",l=>{const s=l.target.files[0];if(s){const u=URL.createObjectURL(s);document.getElementById("currentAvatarPreview").src=u,console.log("Avatar local preview set")}})}catch(r){console.error("L·ªói t·∫£i Profile Modal HTML:",r),t.innerHTML='<p style="padding: 20px;">L·ªói t·∫£i giao di·ªán. Vui l√≤ng th·ª≠ l·∫°i.</p>';return}typeof window.initProfileModal=="function"?await window.initProfileModal():console.warn("H√†m initProfileModal ch∆∞a ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a."),window.currentUser||(t.innerHTML='<p style="padding: 20px;">Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i ƒë·ªÉ xem th√¥ng tin c√° nh√¢n.</p>')}async function Pe(e=!1){const t=window.currentUser,n=document.getElementById("historyTrackList");if(!(!t||!n)){if(B&&!e){const o=B.map(r=>r.tracks);window.displayTracks&&window.displayTracks(o,n);return}n.innerHTML="<p>ƒêang t·∫£i l·ªãch s·ª≠...</p>";try{const{data:o,error:r}=await c.from("history").select(`
                track_id, 
                played_at, 
                tracks (id, title, artist, file_url, cover_url) 
            `).eq("user_id",t.id).order("played_at",{ascending:!1}).limit(20);if(r)throw r;if(B=o,n.innerHTML="",o.length===0)n.innerHTML='<p class="empty-message">B·∫°n ch∆∞a ph√°t b√†i h√°t n√†o g·∫ßn ƒë√¢y.</p>';else{const a=o.map(i=>i.tracks);window.displayTracks&&window.displayTracks(a,n)}}catch(o){console.error("L·ªói t·∫£i l·ªãch s·ª≠:",o),n.innerHTML='<p class="error-message">L·ªói t·∫£i l·ªãch s·ª≠ ph√°t nh·∫°c.</p>'}}}window.openCreatePlaylistModal=function(){console.log("--- B·∫Øt ƒë·∫ßu m·ªü modal t·∫°o playlist ---");const e=document.getElementById("createPlaylistModal");if(e){e.style.display="flex";const t=document.getElementById("createPlaylistForm");if(t){const n=window.handleCreatePlaylistSubmit||handleCreatePlaylistSubmit;if(typeof n!="function"){console.error("L·ªói: handleCreatePlaylistSubmit ch∆∞a ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a ho·∫∑c ch∆∞a ƒë∆∞·ª£c g·∫Øn v√†o window.");return}t.removeEventListener("submit",n),t.addEventListener("submit",n),console.log("Form submit listener attached.")}else console.error('L·ªói: Kh√¥ng t√¨m th·∫•y form ID="createPlaylistForm".')}else console.error('L·ªói: Kh√¥ng t√¨m th·∫•y modal ID="createPlaylistModal".')};window.renderTrackItem=function(e,t,n){const o=document.createElement("div");o.className="track-item playable-track",o.dataset.trackId=e.id;const r=window.getAssetUrl("assets/default-cover.webp"),a=(e.title||"Unknown Title").trim(),i=(e.artist||"Unknown Artist").trim(),l=e.cover_url||r;return o.innerHTML=`
        <div class="track-info">
            <span class="track-index">${t+1}</span>
            <img src="${l}" alt="${a}" class="track-cover" 
                 onerror="if(!this._tried){this._tried=true;this.src='${r}';}">
            <div class="track-details">
                <div class="track-name marquee-container">
                    <span class="track-title-inner">${a}</span>
                </div>
                <div class="track-artist">${i}</div>
            </div>
        </div>
        <div class="track-actions">
            <div class="playlist-add-container">
                <button class="btn-action" 
                        onclick="window.appFunctions.togglePlaylistDropdown(this, '${e.id}')"
                        title="Th√™m v√†o playlist">
                    <i class="fas fa-plus"></i>
                </button>
                <div class="playlist-dropdown"></div>
            </div>

            <!-- N√öT X√ìA - CH·ªà HI·ªÜN ·ªû UPLOADS -->
            ${n==="myUploadsList"?`
            <button class="btn-action text-danger" 
                    onclick="event.stopPropagation(); window.appFunctions.deleteTrack('${e.id}')" 
                    title="X√≥a b√†i h√°t">
                <i class="fas fa-trash"></i>
            </button>`:""}
        </div>
    `,o.addEventListener("click",s=>{var p;if(s.target.closest(".btn-action"))return;const u=((p=window.currentPlaylists)==null?void 0:p[n])||[];window.playTrack(e,u,t)}),setTimeout(()=>{const s=o.querySelector(".track-title-inner"),u=o.querySelector(".marquee-container");s&&u&&s.scrollWidth>u.clientWidth&&s.classList.add("marquee")},100),o};window.renderTrackList=function(e,t){const n=document.getElementById(t);if(n){if(n.innerHTML="",window.currentPlaylists=window.currentPlaylists||{},window.currentPlaylists[t]=e,e.length===0){n.innerHTML='<p class="empty-message">Kh√¥ng c√≥ b√†i h√°t</p>';return}e.forEach((o,r)=>{const a=window.renderTrackItem(o,r,t);n.appendChild(a)}),console.log(`Displayed ${e.length} tracks in ${t}`)}};window.loadMyUploads=async function(e=!1){const t=document.getElementById("myUploadsList");if(!t)return;if((e||!b||b.length===0)&&(b=null,console.log("Cache invalidated for uploads")),b&&!e){window.displayTracks(b,t);return}t.innerHTML="<p>ƒêang t·∫£i danh s√°ch b√†i h√°t...</p>";const n=window.currentUser;if(!n){console.error("No user session for uploads"),t.innerHTML='<p class="error-message">Vui l√≤ng ƒëƒÉng nh·∫≠p.</p>';return}try{console.log("üîÑ Loading uploads for user:",n.id);const{data:o,error:r}=await te(()=>c.from("tracks").select("*, users!user_id (username)").eq("user_id",n.id).order("uploaded_at",{ascending:!1}));if(r)throw r;if(b=o||[],console.log(`‚úÖ Loaded ${o.length} uploads`),o.length===0){t.innerHTML='<p class="empty-message">B·∫°n ch∆∞a t·∫£i l√™n b√†i h√°t n√†o.</p>';return}window.displayTracks(o,t)}catch(o){console.error("‚ùå L·ªói t·∫£i uploads sau t·∫•t c·∫£ retry:",o),t.innerHTML=`<p class="error-message">L·ªói khi t·∫£i: ${o.message}</p>`}};window.loadHomePage=async function(){if(F){console.log("Home page already loaded, skipping");return}const e=document.getElementById("mainContentArea");if(!e){console.error("mainContentArea not found");return}try{F=!0,console.log("Starting loadHomePage...");const t=window.getBaseUrl()+"/home-content.html";console.log("Fetching home content from:",t);const n=await fetch(t);if(!n.ok)throw new Error(`HTTP ${n.status}`);const o=await n.text();e.innerHTML=o,console.log("home-content.html loaded into #mainContentArea"),await new Promise(s=>setTimeout(s,100));const r=document.getElementById("home-section"),a=document.getElementById("playlistGrid"),i=document.getElementById("historyTrackList"),l=document.getElementById("recommendList");if(!r){console.error("home-section not found in loaded HTML!"),e.innerHTML+='<p class="error-message">Thi·∫øu #home-section trong home-content.html</p>';return}console.log("All home elements ready"),await window.appFunctions.loadUserPlaylists(),await window.renderRecentHistory(),await window.renderRecommendations(),window.switchTab("home")}catch(t){console.error("L·ªói loadHomePage:",t),F=!1,e.innerHTML=`
            <div class="error-message">
                <h3>Kh√¥ng t·∫£i ƒë∆∞·ª£c trang ch·ªß</h3>
                <p>${t.message}</p>
                <button onclick="window.loadHomePage()" class="btn-retry">Th·ª≠ l·∫°i</button>
            </div>
        `}};window.handleLogout=async function(){if(confirm("B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?")){console.log("ƒêƒÉng xu·∫•t");try{await window.authFunctions.logout()}catch(e){console.error("L·ªói khi ƒëƒÉng xu·∫•t:",e)}window.currentUser=null,E(),window.location.href=H()+"/index.html"}};window.appFunctions.handleLogout=window.handleLogout;async function Se(){try{const e=window.currentUser;if(!e)return null;const{data:t,error:n}=await c.from("history").select("track_id, played_at, tracks(id, title, artist, cover_url, file_url)").eq("user_id",e.id).order("played_at",{ascending:!1}).limit(1);return n?(console.warn("L·ªói query history:",n.message),null):!t||t.length===0?(console.log("Kh√¥ng c√≥ l·ªãch s·ª≠ ph√°t"),null):{track:t[0].tracks,played_at:t[0].played_at}}catch(e){return console.error("L·ªói getRecentTrack:",e),null}}async function Ue(){const e=await Se();if(!(e!=null&&e.track)){console.log("Kh√¥ng c√≥ b√†i h√°t g·∫ßn ƒë√¢y ƒë·ªÉ resume");return}let t=0;const n=15,o=async()=>{var r;if(window.updatePlayerBar&&document.getElementById("playerBar")){const a=await((r=window.getRecommendationsAsPlaylist)==null?void 0:r.call(window))||[],i=a.findIndex(l=>l.id===e.track.id);window.playTrack(e.track,a,i>=0?i:0),console.log(`ƒê√£ resume: "${e.track.title}"`);return}t<n?(t++,setTimeout(o,300)):console.warn("Player bar kh√¥ng s·∫µn s√†ng sau 4.5s")};o()}window.togglePlaylistDropdown=async function(e,t){console.log("Toggle dropdown cho track:",t);const n=e.closest(".playlist-add-container");if(!n)return console.error("Kh√¥ng t√¨m th·∫•y .playlist-add-container");const o=n.querySelector(".playlist-dropdown");if(!o)return console.error("Kh√¥ng t√¨m th·∫•y .playlist-dropdown");if(document.querySelectorAll(".playlist-dropdown.active").forEach(a=>{a!==o&&(a.classList.remove("active"),document.body.classList.remove("dropdown-open"),console.log("Closed other dropdown"))}),o.classList.contains("active"))o.classList.remove("active"),document.body.classList.remove("dropdown-open"),document.removeEventListener("click",window.outsideClickHandler),o.removeEventListener("mouseleave",window.mouseLeaveHandler),console.log(`Dropdown state: on ‚Üí off for ${t}`);else{const a=e.getBoundingClientRect(),i=0,l=220;let s=a.right+window.scrollX+i,u="right";const p=window.innerWidth+window.scrollX-20;s+l>p&&(s=a.left+window.scrollX-i-l,u="left-flip",console.log("Off-screen detected: Flipped to left align (left="+s+")")),o.style.top=`${a.bottom+window.scrollY+i}px`,o.style.left=`${s}px`,o.style.width=`${l}px`,o.style.right="auto",o.style.height="auto",o.classList.add("active"),document.body.classList.add("dropdown-open"),console.log(`Dropdown after active: display=${getComputedStyle(o).display}, opacity=${getComputedStyle(o).opacity}, position=${getComputedStyle(o).position}, bg=${getComputedStyle(o).backgroundColor}, z=${getComputedStyle(o).zIndex}`),console.log(`Rect after: top=${o.getBoundingClientRect().top}, left=${o.getBoundingClientRect().left}, width=${o.getBoundingClientRect().width}, height=${o.offsetHeight}px, visible=${o.offsetHeight>0}, align=${u}`),o.innerHTML="";try{const w=window.currentUser;if(!w)o.innerHTML='<div class="empty-message">ƒêƒÉng nh·∫≠p ƒë·ªÉ th√™m playlist</div>';else{let f=window.cachedPlaylists||[];if(f.length===0){const{data:P,error:M}=await c.from("playlists").select("id, name, color").eq("user_id",w.id).order("created_at",{ascending:!1});if(M)throw M;f=P||[],window.cachedPlaylists=f,console.log(`Fetched & cached ${f.length} playlists`)}else console.log(`Using cached ${f.length} playlists`);let g="";f.length===0?g=`<div class="playlist-option create-new" onclick="appFunctions.createNewPlaylist('${t}'); event.stopPropagation(); event.preventDefault(); closeDropdown('${t}');"> + T·∫°o playlist m·ªõi </div>`:(f.forEach(P=>{g+=`<div class="playlist-option" style="border-left: 3px solid ${P.color||"#1DB954"};" onclick="appFunctions.addTrackToPlaylist('${t}', '${P.id}'); event.stopPropagation(); event.preventDefault(); closeDropdown('${t}');"> ${P.name} </div>`}),g+=`<div class="playlist-option create-new" onclick="appFunctions.createNewPlaylist('${t}'); event.stopPropagation(); event.preventDefault(); closeDropdown('${t}');"> + T·∫°o playlist m·ªõi </div>`),o.innerHTML=g,console.log(`HTML set: ${g.substring(0,100)}...`),o.style.height="auto",o.offsetHeight,console.log(`Reflow triggered: new height=${o.offsetHeight}px`)}o.dataset.loaded="true"}catch(w){console.error("L·ªói load playlist dropdown:",w),o.innerHTML='<div class="error-message">L·ªói t·∫£i playlist</div>',o.offsetHeight}window.mouseLeaveHandler=()=>{setTimeout(()=>{o.classList.remove("active"),document.body.classList.remove("dropdown-open"),document.removeEventListener("click",window.outsideClickHandler),o.removeEventListener("mouseleave",window.mouseLeaveHandler),console.log(`Closed on mouse leave for ${t}`)},200)},o.addEventListener("mouseleave",window.mouseLeaveHandler),window.outsideClickHandler=w=>{!o.contains(w.target)&&!e.contains(w.target)&&(o.classList.remove("active"),document.body.classList.remove("dropdown-open"),document.removeEventListener("click",window.outsideClickHandler),o.removeEventListener("mouseleave",window.mouseLeaveHandler),console.log(`Closed on outside click for ${t}`))},document.addEventListener("click",window.outsideClickHandler),console.log(`Dropdown state: off ‚Üí on (under-right fixed, align=${u}) for ${t}`)}};window.appFunctions.togglePlaylistDropdown=window.togglePlaylistDropdown;window.closeDropdown=function(e){const t=document.querySelector(`.btn-add-playlist[data-track-id="${e}"]`);if(!t)return;const n=t.closest(".playlist-add-container"),o=n==null?void 0:n.querySelector(".playlist-dropdown");o&&(o.classList.remove("active"),document.body.classList.remove("dropdown-open"))};window.appFunctions.addTrackToPlaylist=async function(e,t){try{const{data:n}=await c.from("playlist_tracks").select("id").eq("playlist_id",t).eq("track_id",e).limit(1);if((n==null?void 0:n.length)>0){alert("B√†i h√°t ƒë√£ c√≥ trong playlist!");return}const{error:o}=await c.from("playlist_tracks").insert({playlist_id:t,track_id:e});if(o)throw o;if(alert("ƒê√£ th√™m v√†o playlist!"),window.loadDetailPlaylist){const r=document.getElementById("playlistDetail");r&&r.dataset.playlistId===t&&window.loadDetailPlaylist(t)}}catch(n){console.error("L·ªói th√™m:",n),alert("L·ªói: "+n.message)}};window.appFunctions.createNewPlaylist=function(e){localStorage.setItem("pendingTrackId",e);const t=document.getElementById("createPlaylistModal");t&&(t.style.display="flex")};function H(){return window.location.origin+"/manh-music"}window.getBaseUrl=H;async function _e(){const e=document.getElementById("historyTrackList");if(!e)return;const t=window.getAssetUrl("assets/default-cover.webp");try{const n=window.currentUser;if(!n)return;const{data:o,error:r}=await c.from("history").select(`
                track_id,
                played_at,
                tracks (
                    id, title, artist, cover_url, file_url
                )
            `).eq("user_id",n.id).order("played_at",{ascending:!1}).limit(5);if(r)throw r;if(!o||o.length===0){e.innerHTML='<p class="empty-message">Ch∆∞a c√≥ b√†i h√°t n√†o ƒë∆∞·ª£c ph√°t g·∫ßn ƒë√¢y.</p>';return}e.innerHTML=o.map((a,i)=>`
            <div class="track-item playable-track" onclick='event.stopPropagation(); window.playTrack(${JSON.stringify(a.tracks)}, [], -1)'>
                <div class="track-info">
                    <span class="track-index">${i+1}</span>
                    <img src="${a.tracks.cover_url||t}" 
                         alt="Cover" class="track-cover" 
                         onerror="this.src='${t}'">
                    <div class="track-details">
                        <div class="track-name">${_(a.tracks.title)}</div>
                        <div class="track-artist">${_(a.tracks.artist)}</div>
                    </div>
                </div>
                <div class="track-actions">
                    <button class="btn-action" onclick="event.stopPropagation(); window.appFunctions.togglePlaylistDropdown(this, '${a.tracks.id}')">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
        `).join(""),console.log(`Loaded ${o.length} recent tracks`)}catch(n){console.error("L·ªói t·∫£i l·ªãch s·ª≠:",n),e.innerHTML='<p class="error-message">L·ªói t·∫£i l·ªãch s·ª≠.</p>'}}window.testAllTrackUrls=async function(){const{data:e,error:t}=await c.from("tracks").select("id, title, file_url");if(t){console.error("‚ùå Error fetching tracks:",t);return}console.log("üîç Testing URLs for",e.length,"tracks");for(const n of e){const o=await window.testAudioUrl(n.id);console.log(`${o?"‚úÖ":"‚ùå"} ${n.title}: ${n.file_url}`),await new Promise(r=>setTimeout(r,100))}};window.switchTab=function(e,t=null){console.log("switchTab:",e,t);const n=document.getElementById("mainContentArea");if(!n)return console.error("mainContentArea not found");n.querySelectorAll(".page-section").forEach(a=>{a.style.display="none"});let o;e==="home"?o="home-section":e==="detail-playlist"?o="playlistDetail":e==="search"?o="search-section":e==="uploads"&&(o="myUploadsSection");const r=document.getElementById(o);r?(r.style.display="block",console.log(`Switched to: ${o}`)):console.warn(`Section not found: ${o}`),e==="detail-playlist"&&t&&window.loadDetailPlaylist&&setTimeout(()=>window.loadDetailPlaylist(t),100),document.querySelectorAll(".sidebar-link").forEach(a=>{a.classList.remove("active"),a.dataset.tab===e&&a.classList.add("active")})};async function L(e){if(window.appInitialized||window.initializationInProgress){console.log("‚è≥ App already initialized or in progress, skipping");return}if(!e){console.error("‚ùå initializeApp called without user");return}window.initializationInProgress=!0,window.currentUser=e,console.log(" Initializing app for user:",e.email||e.id),console.log("üß™ Testing connection...");const t=await Ee();await oe(),t?console.log("‚úÖ All connection tests passed"):(console.error("üö® Connection tests failed - showing warning"),D());try{await U(e),await window.loadHomePage(),await window.switchTab("home"),await Z(!0),window.userSessionLoaded||(window.userSessionLoaded=!0,await Ue(e)),window.appInitialized=!0,console.log("‚úÖ App fully initialized")}catch(n){console.error("‚ùå App initialization failed:",n),D==null||D()}finally{window.initializationInProgress=!1}}function E(){console.log("üîÑ Resetting all caches for fresh start"),q=null,B=null,S=null,C=null,k=null,b=null,window.playlistsLoadFlag=!1}document.addEventListener("DOMContentLoaded",async()=>{console.log("üì¶ DOM Content Loaded");const{data:{session:e}}=await c.auth.getSession();if(console.log("SESSION AT DOMContentLoaded:",e,"at",performance.now()),e!=null&&e.user?(window.currentUser=e.user,window.appInitialized?console.log("‚è≥ App ƒë√£ init tr∆∞·ªõc ƒë√≥, b·ªè qua DOMContentLoaded"):(await L(e.user),window.appInitialized=!0)):(console.warn("‚ö†Ô∏è No active session - but NOT redirecting (debug mode); force getUser"),c.auth.getUser().then(({data:{user:n},error:o})=>{n?(window.currentUser=n,console.log("‚úÖ DOMLoaded force getUser success:",n.id),L(n)):(console.error("getUser also failed:",o),window.location.href("/manh-music/"+"index.html"))})),window.appInitialized){console.log("üîÑ App already initialized, skipping DOMContentLoaded");return}if(window._oauthEarlyUser){console.log("üîÅ Found early OAuth user on DOMContentLoaded:",window._oauthEarlyUser.id);try{await L(window._oauthEarlyUser),window._oauthEarlyUser=null,window.appInitialized=!0;return}catch(n){console.error("‚ùå Error initializing app with early OAuth user:",n),window.appInitialized=!1}}const t=window.location.hash.substring(1);if(t){const n=new URLSearchParams(t),o=n.get("access_token"),r=n.get("refresh_token");if(o&&r)try{console.log("üîë Found OAuth tokens in URL ‚Äî setting Supabase session...");const{data:{session:a},error:i}=await c.auth.setSession({access_token:o,refresh_token:r});if(i){console.error("‚ùå Set session error:",i),window.location.href("/manh-music/"+"index.html");return}if(!(a!=null&&a.user)){console.warn("‚ö†Ô∏è setSession returned session without user"),window.location.href("/manh-music/"+"index.html");return}console.log("‚úÖ Session established from OAuth for:",a.user.email),history.replaceState({},document.title,window.location.pathname),await L(a.user),window.appInitialized=!0;return}catch(a){console.error("‚ùå OAuth processing error:",a),window.location.href("/manh-music/"+"index.html");return}}try{const{data:{session:n},error:o}=await c.auth.getSession();if(o&&console.error("‚ùå Session retrieval error:",o),n!=null&&n.user){console.log("‚úÖ Existing session found:",n.user.email),await L(n.user),window.appInitialized=!0;return}else{console.warn("‚ö†Ô∏è No active session found ‚Äî redirecting to login"),window.location.href("/manh-music/"+"index.html");return}}catch(n){console.error("‚ùå Error checking existing session:",n),window.location.href("/manh-music/"+"index.html");return}});c.auth.onAuthStateChange(async(e,t)=>{var n;console.log("‚öôÔ∏è Auth state changed:",e,((n=t==null?void 0:t.user)==null?void 0:n.email)||"no user"),console.log("SIGNED_IN event, user:",t==null?void 0:t.user,"at",performance.now()),e==="SIGNED_IN"&&(t!=null&&t.user)&&(console.log("‚úÖ User signed in:",t.user.email),window.appInitialized=!1,E==null||E(),await L(t.user),window.appInitialized=!0,setTimeout(oe,1e3)),e==="SIGNED_OUT"&&(console.log(" User signed out ‚Äî resetting app"),window.appInitialized=!1,U==null||U(null),E==null||E(),window.currentAudio&&(window.currentAudio.pause(),window.currentAudio=null),window.isPlaying=!1,window.location.pathname.includes("index.html")||window.location.href("/manh-music/"+"index.html"))});function ie(e){e==="home"&&(window.location.href=H()+"/index.html")}window.currentPlaylist=m;window.currentTrackIndex=T;window.isShuffling=y;window.shuffleOrder=$;window.repeatMode=A;window.navigateTo=ie;window.uploadTrack=async function(){const e=document.getElementById("trackFile"),t=document.getElementById("coverFileInput"),n=document.getElementById("trackTitleInput"),o=document.getElementById("trackArtistInput"),r=e.files[0],a=t.files[0];if(!r){alert("Vui l√≤ng ch·ªçn m·ªôt file nh·∫°c.");return}const{data:i,error:l}=await c.auth.getUser();if(l||!i.user){alert("L·ªói x√°c th·ª±c: Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.");return}const s=i.user.id;let u=null;try{if(a){console.log(`B·∫Øt ƒë·∫ßu t·∫£i ·∫£nh b√¨a: ${a.name}`);const le=a.name.split(".").pop(),V=`${s}/${Date.now()}_cover.${le}`,{error:Q}=await c.storage.from("cover").upload(V,a);if(Q)throw new Error(`L·ªói t·∫£i ·∫£nh b√¨a: ${Q.message}`);const{data:se}=c.storage.from("cover").getPublicUrl(V);u=se.publicUrl}console.log(`B·∫Øt ƒë·∫ßu t·∫£i file nh·∫°c: ${r.name}`);const p=r.name.split(".").pop(),w=`${s}/${Date.now()}.${p}`,{error:f}=await c.storage.from("music-files").upload(w,r);if(f)throw new Error(`L·ªói t·∫£i file nh·∫°c: ${f.message}`);const{data:g}=c.storage.from("music-files").getPublicUrl(w),P=g.publicUrl,M={user_id:s,title:n.value||r.name.replace(`.${p}`,""),artist:o.value||"Unknown Artist",file_url:P,cover_url:u,uploaded_at:new Date().toISOString()},{error:G}=await c.from("tracks").insert([M]);if(G)throw new Error(`L·ªói l∆∞u DB: ${G.message}`);e.value="",t&&(t.value=""),n.value="",o.value="",window.switchTab&&window.switchTab("uploads"),window.cachedMyUploads&&(window.cachedMyUploads=null,console.log("Cache uploads cleared after successful upload")),window.loadMyUploads&&(window.loadMyUploads(!0),console.log("Force refreshed uploads after upload"))}catch(p){console.error("L·ªói khi upload:",p),alert(`L·ªói khi t·∫£i l√™n: ${p.message}`)}};window.switchTab=function(e,t=null){const n=document.querySelectorAll("#mainContentArea .main-section"),o=document.querySelectorAll(".sidebar-left .menu-item");let r=!1;const a=e+"-section";if(n.forEach(i=>{i.id===a?(i.style.display="block",r=!0):i.style.display="none"}),!r){console.warn(`Section "${a}" kh√¥ng t·ªìn t·∫°i trong v√πng ch·ª©a n·ªôi dung.`);return}e==="detail-playlist"&&t?window.loadDetailPlaylist?window.loadDetailPlaylist(t):console.error("H√†m loadDetailPlaylist kh√¥ng t·ªìn t·∫°i"):e==="uploads"&&window.loadMyUploads?window.loadMyUploads(!0):e==="recommend"&&window.renderRecommendations&&window.renderRecommendations(),o.forEach(i=>{i.getAttribute("data-section")===e?i.classList.add("active"):i.classList.remove("active")})};
