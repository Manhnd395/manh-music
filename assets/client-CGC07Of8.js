import{createClient as g}from"https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))e(t);new MutationObserver(t=>{for(const o of t)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&e(r)}).observe(document,{childList:!0,subtree:!0});function s(t){const o={};return t.integrity&&(o.integrity=t.integrity),t.referrerPolicy&&(o.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?o.credentials="include":t.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function e(t){if(t.ep)return;t.ep=!0;const o=s(t);fetch(t.href,o)}})();console.log("ðŸ“¦ client.js loaded - initializing Supabase client");const u=window.SUPABASE_URL,i=window.SUPABASE_ANON_KEY;if(!u||!i)throw new Error("Supabase config missing");window.location.hostname==="localhost"&&(console.log("DEBUG: SUPABASE_URL:",u),console.log("DEBUG: ANON_KEY length:",(i==null?void 0:i.length)||0));const a=g(u,i,{auth:{persistSession:!0}});window.supabase=a;(async function(){var s;if(localStorage.getItem("manh-music-logout")==="true"){console.log("Detected recent logout â€” clearing auth & skipping restore"),localStorage.removeItem("manh-music-logout"),localStorage.removeItem("manh-music-logout-time"),Object.keys(localStorage).forEach(e=>{(e.includes("sb-")||e.includes("supabase.auth")||e.includes("token"))&&localStorage.removeItem(e)}),window.dispatchEvent(new CustomEvent("SUPABASE_SESSION_RESTORED",{detail:{session:null}}));return}try{const{data:{session:e},error:t}=await a.auth.getSession();if(console.log("client.js getSession result:",((s=e==null?void 0:e.user)==null?void 0:s.email)??null,t??null),e!=null&&e.user){window.currentUser=e.user,console.log("âœ… Client session restored & dispatched:",e.user.email);const o=Math.floor(Date.now()/1e3);if(e.expires_at<o+300){console.log("ðŸ”„ Token near expiry - refreshing session");const{data:{session:r},error:l}=await a.auth.refreshSession({refresh_token:e.refresh_token});l?(console.error("âŒ Refresh failed:",l),localStorage.removeItem("sb-lezswjtnlsmznkgrzgmu-auth-token")):r!=null&&r.user&&(window.currentUser=r.user,console.log("ðŸ”„ Client session refreshed:",r.user.email),e=r)}a.from("users").select("id").eq("id",e.user.id).single().then(({data:r,error:l})=>{l?console.warn("âš ï¸ Quick RLS test failed in client.js:",l.message):console.log("âœ… Client RLS quick test OK")}).catch(r=>console.warn("Quick test failed:",r)),window.dispatchEvent(new CustomEvent("SUPABASE_SESSION_RESTORED",{detail:{session:e}}))}else{console.warn("âŒ No session in client.js - clearing storage if corrupt");const o=localStorage.getItem("sb-lezswjtnlsmznkgrzgmu-auth-token");if(o)try{JSON.parse(o)}catch{localStorage.removeItem("sb-lezswjtnlsmznkgrzgmu-auth-token"),console.log("ðŸ”„ Cleared corrupt auth token")}window.dispatchEvent(new CustomEvent("SUPABASE_SESSION_RESTORED",{detail:{session:null,error:t}}))}}catch(e){console.warn("Error getting session:",e),window.dispatchEvent(new CustomEvent("SUPABASE_SESSION_RESTORED",{detail:{session:null,error:e}}))}})();a.auth.onAuthStateChange((c,n)=>{var s;if(localStorage.getItem("manh-music-logout")==="true"){console.log("onAuthStateChange ignored due to logout flag");return}console.log("client.js AUTH STATE CHANGED:",c,((s=n==null?void 0:n.user)==null?void 0:s.email)??"no user","at",new Date().toISOString()),window.currentUser=(n==null?void 0:n.user)??null,window.dispatchEvent(new CustomEvent("SUPABASE_AUTH_CHANGE",{detail:{event:c,session:n}}))});export{a as s};
