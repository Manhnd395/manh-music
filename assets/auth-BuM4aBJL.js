import{s as u}from"./client-CGC07Of8.js";if(!u)throw console.error("SUPABASE CLIENT NOT INITIALIZED! Check load order: client.js must load before auth.js"),new Error("Supabase client missing");console.log("Script loaded:",window.location.href);document.addEventListener("DOMContentLoaded",async function(){const e=window.location.pathname;console.log("Auth.js checking path:",e);try{console.log("Auth.js: Restoring session via getSession...");const{data:{session:o},error:s}=await u.auth.getSession();if(s)throw s;if(o!=null&&o.user){if(window.currentUser=o.user,console.log("Session restored:",o.user.email),window.dispatchEvent(new CustomEvent("SUPABASE_SESSION_RESTORED",{detail:{session:o}})),window.dispatchEvent(new CustomEvent("SUPABASE_AUTH_CHANGE",{detail:{event:"INITIAL_SESSION",session:o}})),e==="/"||e.includes("index.html")||e.includes("signup.html")){window.location.href="/player.html";return}}else console.warn("No session - show login form"),e.includes("player.html")&&(window.location.href="/index.html")}catch(o){console.error("Session restore error:",o),e.includes("player.html")&&(window.location.href="/index.html")}console.log("DOM fully loaded, searching for forms...");const n=document.getElementById("signupForm");n&&(console.log("FOUND signupForm"),n.addEventListener("submit",async o=>{o.preventDefault(),console.log("SIGNUP SUBMIT"),await w()}));const t=document.getElementById("loginForm");t&&(console.log("FOUND loginForm"),t.addEventListener("submit",async o=>{o.preventDefault(),console.log("LOGIN SUBMIT"),await p()}))});function r(e,n){const t=document.getElementById(`${e}Error`),o=document.getElementById(e);t&&o&&(t.textContent="",t.classList.remove("active"),o.classList.remove("error"),n&&(t.textContent=n,t.classList.add("active"),o.classList.add("error")))}function y(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}function S(e){return/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[\W_]).{8,}$/.test(e)}async function w(){const e=document.getElementById("signupUsername").value.trim(),n=document.getElementById("signupEmail").value.trim(),t=document.getElementById("signupPassword").value,o=document.getElementById("confirmPassword").value,s=document.getElementById("signupBirthday").value;r("signupUsername",null),r("signupEmail",null),r("signupPassword",null),r("confirmPassword",null),r("signupBirthday",null);let a=!1;if(e||(r("signupUsername","Vui lÃ²ng nháº­p TÃªn ngÆ°á»i dÃ¹ng."),a=!0),n?y(n)||(r("signupEmail","Äá»‹nh dáº¡ng Email khÃ´ng há»£p lá»‡."),a=!0):(r("signupEmail","Vui lÃ²ng nháº­p Email."),a=!0),t?S(t)||(r("signupPassword","Máº­t kháº©u pháº£i cÃ³ Ã­t nháº¥t 8 kÃ½ tá»±, bao gá»“m chá»¯ hoa, chá»¯ thÆ°á»ng, sá»‘ vÃ  kÃ½ tá»± Ä‘áº·c biá»‡t."),a=!0):(r("signupPassword","Vui lÃ²ng nháº­p Máº­t kháº©u."),a=!0),o?t!==o&&(r("confirmPassword","Máº­t kháº©u xÃ¡c nháº­n khÃ´ng khá»›p."),a=!0):(r("confirmPassword","Vui lÃ²ng nháº­p láº¡i Máº­t kháº©u."),a=!0),s||(r("signupBirthday","Vui lÃ²ng nháº­p NgÃ y sinh."),a=!0),!a)try{const{count:i,error:g}=await u.from("users").select("username",{count:"exact"}).eq("username",e);if(g)throw new Error(`Lá»—i kiá»ƒm tra tÃªn ngÆ°á»i dÃ¹ng: ${g.message}`);if(i>0){r("signupUsername","TÃªn ngÆ°á»i dÃ¹ng nÃ y Ä‘Ã£ tá»“n táº¡i.");return}const{data:d,error:m}=await u.auth.signUp({email:n,password:t,options:{data:{username:e,birthday:s}}});if(m){console.error("Signup error:",m),m.message.includes("already registered")?r("signupEmail","Email nÃ y Ä‘Ã£ Ä‘Æ°á»£c Ä‘Äƒng kÃ½."):r("signupEmail",`ÄÄƒng kÃ½ tháº¥t báº¡i: ${m.message}`);return}console.log("Signup success:",d.user.email);const{error:c}=await u.from("users").upsert({id:d.user.id,email:n,username:e,birthday:s,avatar_url:null,updated_at:new Date().toISOString()});c?console.error("Upsert users error:",c):console.log("âœ… Users table populated"),alert("ÄÄƒng kÃ½ thÃ nh cÃ´ng! Vui lÃ²ng kiá»ƒm tra email Ä‘á»ƒ xÃ¡c nháº­n vÃ  Ä‘Äƒng nháº­p."),window.location.href="/index.html";return}catch(i){console.error("Lá»—i há»‡ thá»‘ng khi Ä‘Äƒng kÃ½:",i),console.error("Exact error:",i.message),r("signupEmail",`Lá»—i há»‡ thá»‘ng: ${i.message}`)}}async function p(){var o,s,a;const e=document.getElementById("loginEmail").value,n=document.getElementById("loginPassword").value,t=document.querySelector('#loginForm button[type="submit"]')||document.getElementById("loginBtn");if(r("loginEmail",null),r("loginPassword",null),!e||!n){e||r("loginEmail","Vui lÃ²ng nháº­p Email."),n||r("loginPassword","Vui lÃ²ng nháº­p Máº­t kháº©u.");return}t&&(t.disabled=!0,t.textContent="Äang Ä‘Äƒng nháº­p...");try{console.log("ðŸ”„ Starting signInWithPassword for",e);const{data:{user:i},error:g}=await u.auth.signInWithPassword({email:e,password:n});if(g){console.error("Login error:",g);const l=g.message.includes("Invalid")?"Email hoáº·c máº­t kháº©u khÃ´ng chÃ­nh xÃ¡c.":`ÄÄƒng nháº­p tháº¥t báº¡i: ${g.message}`;r("loginPassword",l),t&&(t.disabled=!1,t.textContent="ÄÄƒng nháº­p");return}console.log("âœ… signIn success, user:",i.email);let d=null;try{const{data:{session:l}}=await u.auth.getSession();d=l,d!=null&&d.user?console.log("ðŸ’¾ Session confirmed:",d.user.email):console.warn("âš ï¸ getSession returned no session - fallback")}catch(l){console.warn("getSession error:",l.message)}window.currentUser=(d==null?void 0:d.user)||i,console.log("ðŸ”„ Set currentUser:",window.currentUser.id);const m=d||{user:i};if(window.dispatchEvent(new CustomEvent("SUPABASE_SESSION_RESTORED",{detail:{session:m}})),window.dispatchEvent(new CustomEvent("SUPABASE_AUTH_CHANGE",{detail:{event:"SIGNED_IN",session:m}})),document.getElementById("loginEmail").value="",document.getElementById("loginPassword").value="",r("loginPassword","ÄÄƒng nháº­p thÃ nh cÃ´ng! Äang chuyá»ƒn hÆ°á»›ng..."),((o=i.app_metadata)==null?void 0:o.provider)==="email"&&!i.email_confirmed_at){console.log("âŒ Email not confirmed"),alert("Email chÆ°a xÃ¡c nháº­n! Vui lÃ²ng kiá»ƒm tra mail vÃ  click link xÃ¡c nháº­n."),t&&(t.disabled=!1,t.textContent="ÄÄƒng nháº­p");return}console.log("âœ… Email confirmed OK");let c=null;try{const{data:l,error:h}=await u.from("users").select("username, birthday, avatar_url").eq("id",i.id).single().timeout(2e3);c=l,h&&h.code!=="PGRST116"&&console.error("Select profile error:",h)}catch(l){console.warn("Select profile timeout:",l)}const E=(c==null?void 0:c.username)||((s=i.user_metadata)==null?void 0:s.username)||e.split("@")[0],f=(c==null?void 0:c.birthday)||((a=i.user_metadata)==null?void 0:a.birthday)||null;u.from("users").upsert({id:i.id,email:i.email,username:E,birthday:f,avatar_url:(c==null?void 0:c.avatar_url)||null,updated_at:new Date().toISOString()}).timeout(2e3).then(({error:l})=>{l?console.error("Upsert error (async):",l):console.log("âœ… Profile upserted (async)")}).catch(l=>console.warn("Upsert timeout (async):",l)),setTimeout(()=>{t&&(t.disabled=!1,t.textContent="ÄÄƒng nháº­p"),window.location.href="/player.html"},300)}catch(i){console.error("Lá»—i há»‡ thá»‘ng loginWithEmail:",i),r("loginPassword",`Lá»—i há»‡ thá»‘ng: ${i.message}`),t&&(t.disabled=!1,t.textContent="ÄÄƒng nháº­p")}}async function I(){console.log("Login with Google called");try{const{data:e,error:n}=await u.auth.signInWithOAuth({provider:"google",options:{redirectTo:`${window.location.origin}/player.html`}});if(n)throw n;console.log("Google OAuth initiated:",e),u.auth.onAuthStateChange((t,o)=>{t==="SIGNED_IN"&&(o!=null&&o.user)&&(window.currentUser=o.user,window.dispatchEvent(new CustomEvent("SUPABASE_AUTH_CHANGE",{detail:{event:t,session:o}})))})}catch(e){console.error("Google login error:",e),alert("Lá»—i Ä‘Äƒng nháº­p Google: "+e.message)}}async function v(){try{console.log("Starting logout..."),localStorage.setItem("manh-music-logout","true"),localStorage.setItem("manh-music-logout-time",Date.now().toString());const e=3e3;let n=null;try{(await Promise.race([u.auth.signOut({scope:"local"}).then(()=>({success:!0})),new Promise(a=>setTimeout(()=>a({timeout:!0}),e))])).timeout?console.warn("signOut timed out"):console.log("Supabase signOut success")}catch(s){n=s,console.error("signOut error:",s)}Object.keys(localStorage).filter(s=>s.startsWith("sb-")||s.includes("supabase.auth")||s.includes("token")).forEach(s=>{localStorage.removeItem(s),console.log("Removed:",s)}),["cachedPlaylists","cachedHistoryTracks","cachedRecommendedTracks","cachedProfile","cachedPlaylistTracks","cachedRecommendationsPlaylistId"].forEach(s=>window[s]=null),window.userSessionLoaded=!1,console.log("Logout cleanup complete"),window.location.replace("/index.html")}catch(e){console.error("Lá»—i logout:",e),localStorage.setItem("manh-music-logout","true"),window.location.replace("/index.html")}}u.auth.onAuthStateChange((e,n)=>{var t;console.log("AUTH STATE CHANGED:",e,((t=n==null?void 0:n.user)==null?void 0:t.email)||"no user"),e==="SIGNED_IN"&&(n!=null&&n.user)&&(window.currentUser=n.user,(window.location.pathname.includes("index.html")||window.location.pathname==="/")&&(window.location.href="/player.html"),window.dispatchEvent(new CustomEvent("SUPABASE_AUTH_CHANGE",{detail:{event:e,session:n}}))),e==="SIGNED_OUT"&&(window.currentUser=null,window.location.href="/index.html")});window.authFunctions={signup:w,loginWithEmail:p,loginWithGoogle:I,logout:v};
