import{createClient as I}from"https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))e(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const s of i.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&e(s)}).observe(document,{childList:!0,subtree:!0});function n(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function e(r){if(r.ep)return;r.ep=!0;const i=n(r);fetch(r.href,i)}})();(()=>{const o="https://lezswjtnlsmznkgrzgmu.supabase.co",t="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxlenN3anRubHNtem5rZ3J6Z211Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1Nzc2MjYsImV4cCI6MjA3NjE1MzYyNn0.7EcHV5IK8r5stTF0uohhFShbWLIaK4A4VEAxYnZG3Vk",n="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";window.SUPABASE_URL=o,window.SUPABASE_ANON_KEY=t,window.GROQ_API_KEY=n,console.log("ENV INJECTED:",{SUPABASE_URL:o,ANON_KEY_LENGTH:(t==null?void 0:t.length)||0,GROQ_OK:!0})})();console.log("ðŸ“¦ client.js loaded - initializing Supabase client");const E=window.SUPABASE_URL,h=window.SUPABASE_ANON_KEY;if(!E||!h)throw new Error("Supabase config missing");window.location.hostname==="localhost"&&(console.log("DEBUG: SUPABASE_URL:",E),console.log("DEBUG: ANON_KEY length:",(h==null?void 0:h.length)||0));const a=I(E,h,{auth:{persistSession:!0}});window.supabase=a;(async function(){var n;if(localStorage.getItem("manh-music-logout")==="true"){console.log("Detected recent logout â€” clearing auth & skipping restore"),localStorage.removeItem("manh-music-logout"),localStorage.removeItem("manh-music-logout-time"),Object.keys(localStorage).forEach(e=>{(e.includes("sb-")||e.includes("supabase.auth")||e.includes("token"))&&localStorage.removeItem(e)}),window.dispatchEvent(new CustomEvent("SUPABASE_SESSION_RESTORED",{detail:{session:null}}));return}try{const{data:{session:e},error:r}=await a.auth.getSession();if(console.log("client.js getSession result:",((n=e==null?void 0:e.user)==null?void 0:n.email)??null,r??null),e!=null&&e.user){window.currentUser=e.user,console.log("âœ… Client session restored & dispatched:",e.user.email);const i=Math.floor(Date.now()/1e3);if(e.expires_at<i+300){console.log("ðŸ”„ Token near expiry - refreshing session");const{data:{session:s},error:u}=await a.auth.refreshSession({refresh_token:e.refresh_token});u?(console.error("âŒ Refresh failed:",u),localStorage.removeItem("sb-lezswjtnlsmznkgrzgmu-auth-token")):s!=null&&s.user&&(window.currentUser=s.user,console.log("ðŸ”„ Client session refreshed:",s.user.email),e=s)}a.from("users").select("id").eq("id",e.user.id).single().then(({data:s,error:u})=>{u?console.warn("âš ï¸ Quick RLS test failed in client.js:",u.message):console.log("âœ… Client RLS quick test OK")}).catch(s=>console.warn("Quick test failed:",s)),window.dispatchEvent(new CustomEvent("SUPABASE_SESSION_RESTORED",{detail:{session:e}}))}else{console.warn("âŒ No session in client.js - clearing storage if corrupt");const i=localStorage.getItem("sb-lezswjtnlsmznkgrzgmu-auth-token");if(i)try{JSON.parse(i)}catch{localStorage.removeItem("sb-lezswjtnlsmznkgrzgmu-auth-token"),console.log("ðŸ”„ Cleared corrupt auth token")}window.dispatchEvent(new CustomEvent("SUPABASE_SESSION_RESTORED",{detail:{session:null,error:r}}))}}catch(e){console.warn("Error getting session:",e),window.dispatchEvent(new CustomEvent("SUPABASE_SESSION_RESTORED",{detail:{session:null,error:e}}))}})();a.auth.onAuthStateChange((o,t)=>{var n;if(localStorage.getItem("manh-music-logout")==="true"){console.log("onAuthStateChange ignored due to logout flag");return}console.log("client.js AUTH STATE CHANGED:",o,((n=t==null?void 0:t.user)==null?void 0:n.email)??"no user","at",new Date().toISOString()),window.currentUser=(t==null?void 0:t.user)??null,window.dispatchEvent(new CustomEvent("SUPABASE_AUTH_CHANGE",{detail:{event:o,session:t}}))});if(!a)throw console.error("SUPABASE CLIENT NOT INITIALIZED! Check load order: client.js must load before auth.js"),new Error("Supabase client missing");console.log("Script loaded:",window.location.href);document.addEventListener("DOMContentLoaded",async function(){const o=window.location.pathname;console.log("Auth.js checking path:",o);try{console.log("Auth.js: Restoring session via getSession...");const{data:{session:e},error:r}=await a.auth.getSession();if(r)throw r;if(e!=null&&e.user){if(window.currentUser=e.user,console.log("Session restored:",e.user.email),window.dispatchEvent(new CustomEvent("SUPABASE_SESSION_RESTORED",{detail:{session:e}})),window.dispatchEvent(new CustomEvent("SUPABASE_AUTH_CHANGE",{detail:{event:"INITIAL_SESSION",session:e}})),o==="/"||o.includes("index.html")||o.includes("signup.html")){window.location.href="/player.html";return}}else console.warn("No session - show login form"),o.includes("player.html")&&(window.location.href="/index.html")}catch(e){console.error("Session restore error:",e),o.includes("player.html")&&(window.location.href="/index.html")}console.log("DOM fully loaded, searching for forms...");const t=document.getElementById("signupForm");t&&(console.log("FOUND signupForm"),t.addEventListener("submit",async e=>{e.preventDefault(),console.log("SIGNUP SUBMIT"),await f()}));const n=document.getElementById("loginForm");n&&(console.log("FOUND loginForm"),n.addEventListener("submit",async e=>{e.preventDefault(),console.log("LOGIN SUBMIT"),await p()}))});function l(o,t){const n=document.getElementById(`${o}Error`),e=document.getElementById(o);n&&e&&(n.textContent="",n.classList.remove("active"),e.classList.remove("error"),t&&(n.textContent=t,n.classList.add("active"),e.classList.add("error")))}function A(o){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(o)}function v(o){return/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[\W_]).{8,}$/.test(o)}async function f(){const o=document.getElementById("signupUsername").value.trim(),t=document.getElementById("signupEmail").value.trim(),n=document.getElementById("signupPassword").value,e=document.getElementById("confirmPassword").value,r=document.getElementById("signupBirthday").value;l("signupUsername",null),l("signupEmail",null),l("signupPassword",null),l("confirmPassword",null),l("signupBirthday",null);let i=!1;if(o||(l("signupUsername","Vui lÃ²ng nháº­p TÃªn ngÆ°á»i dÃ¹ng."),i=!0),t?A(t)||(l("signupEmail","Äá»‹nh dáº¡ng Email khÃ´ng há»£p lá»‡."),i=!0):(l("signupEmail","Vui lÃ²ng nháº­p Email."),i=!0),n?v(n)||(l("signupPassword","Máº­t kháº©u pháº£i cÃ³ Ã­t nháº¥t 8 kÃ½ tá»±, bao gá»“m chá»¯ hoa, chá»¯ thÆ°á»ng, sá»‘ vÃ  kÃ½ tá»± Ä‘áº·c biá»‡t."),i=!0):(l("signupPassword","Vui lÃ²ng nháº­p Máº­t kháº©u."),i=!0),e?n!==e&&(l("confirmPassword","Máº­t kháº©u xÃ¡c nháº­n khÃ´ng khá»›p."),i=!0):(l("confirmPassword","Vui lÃ²ng nháº­p láº¡i Máº­t kháº©u."),i=!0),r||(l("signupBirthday","Vui lÃ²ng nháº­p NgÃ y sinh."),i=!0),!i)try{const{count:s,error:u}=await a.from("users").select("username",{count:"exact"}).eq("username",o);if(u)throw new Error(`Lá»—i kiá»ƒm tra tÃªn ngÆ°á»i dÃ¹ng: ${u.message}`);if(s>0){l("signupUsername","TÃªn ngÆ°á»i dÃ¹ng nÃ y Ä‘Ã£ tá»“n táº¡i.");return}const{data:g,error:m}=await a.auth.signUp({email:t,password:n,options:{data:{username:o,birthday:r}}});if(m){console.error("Signup error:",m),m.message.includes("already registered")?l("signupEmail","Email nÃ y Ä‘Ã£ Ä‘Æ°á»£c Ä‘Äƒng kÃ½."):l("signupEmail",`ÄÄƒng kÃ½ tháº¥t báº¡i: ${m.message}`);return}console.log("Signup success:",g.user.email);const{error:d}=await a.from("users").upsert({id:g.user.id,email:t,username:o,birthday:r,avatar_url:null,updated_at:new Date().toISOString()});d?console.error("Upsert users error:",d):console.log("âœ… Users table populated"),alert("ÄÄƒng kÃ½ thÃ nh cÃ´ng! Vui lÃ²ng kiá»ƒm tra email Ä‘á»ƒ xÃ¡c nháº­n vÃ  Ä‘Äƒng nháº­p."),window.location.href="/index.html";return}catch(s){console.error("Lá»—i há»‡ thá»‘ng khi Ä‘Äƒng kÃ½:",s),console.error("Exact error:",s.message),l("signupEmail",`Lá»—i há»‡ thá»‘ng: ${s.message}`)}}async function p(){var e,r,i;const o=document.getElementById("loginEmail").value,t=document.getElementById("loginPassword").value,n=document.querySelector('#loginForm button[type="submit"]')||document.getElementById("loginBtn");if(l("loginEmail",null),l("loginPassword",null),!o||!t){o||l("loginEmail","Vui lÃ²ng nháº­p Email."),t||l("loginPassword","Vui lÃ²ng nháº­p Máº­t kháº©u.");return}n&&(n.disabled=!0,n.textContent="Äang Ä‘Äƒng nháº­p...");try{console.log("ðŸ”„ Starting signInWithPassword for",o);const{data:{user:s},error:u}=await a.auth.signInWithPassword({email:o,password:t});if(u){console.error("Login error:",u);const c=u.message.includes("Invalid")?"Email hoáº·c máº­t kháº©u khÃ´ng chÃ­nh xÃ¡c.":`ÄÄƒng nháº­p tháº¥t báº¡i: ${u.message}`;l("loginPassword",c),n&&(n.disabled=!1,n.textContent="ÄÄƒng nháº­p");return}console.log("âœ… signIn success, user:",s.email);let g=null;try{const{data:{session:c}}=await a.auth.getSession();g=c,g!=null&&g.user?console.log("ðŸ’¾ Session confirmed:",g.user.email):console.warn("âš ï¸ getSession returned no session - fallback")}catch(c){console.warn("getSession error:",c.message)}window.currentUser=(g==null?void 0:g.user)||s,console.log("ðŸ”„ Set currentUser:",window.currentUser.id);const m=g||{user:s};if(window.dispatchEvent(new CustomEvent("SUPABASE_SESSION_RESTORED",{detail:{session:m}})),window.dispatchEvent(new CustomEvent("SUPABASE_AUTH_CHANGE",{detail:{event:"SIGNED_IN",session:m}})),document.getElementById("loginEmail").value="",document.getElementById("loginPassword").value="",l("loginPassword","ÄÄƒng nháº­p thÃ nh cÃ´ng! Äang chuyá»ƒn hÆ°á»›ng..."),((e=s.app_metadata)==null?void 0:e.provider)==="email"&&!s.email_confirmed_at){console.log("âŒ Email not confirmed"),alert("Email chÆ°a xÃ¡c nháº­n! Vui lÃ²ng kiá»ƒm tra mail vÃ  click link xÃ¡c nháº­n."),n&&(n.disabled=!1,n.textContent="ÄÄƒng nháº­p");return}console.log("âœ… Email confirmed OK");let d=null;try{const{data:c,error:w}=await a.from("users").select("username, birthday, avatar_url").eq("id",s.id).single().timeout(2e3);d=c,w&&w.code!=="PGRST116"&&console.error("Select profile error:",w)}catch(c){console.warn("Select profile timeout:",c)}const S=(d==null?void 0:d.username)||((r=s.user_metadata)==null?void 0:r.username)||o.split("@")[0],y=(d==null?void 0:d.birthday)||((i=s.user_metadata)==null?void 0:i.birthday)||null;a.from("users").upsert({id:s.id,email:s.email,username:S,birthday:y,avatar_url:(d==null?void 0:d.avatar_url)||null,updated_at:new Date().toISOString()}).timeout(2e3).then(({error:c})=>{c?console.error("Upsert error (async):",c):console.log("âœ… Profile upserted (async)")}).catch(c=>console.warn("Upsert timeout (async):",c)),setTimeout(()=>{n&&(n.disabled=!1,n.textContent="ÄÄƒng nháº­p"),window.location.href="/player.html"},300)}catch(s){console.error("Lá»—i há»‡ thá»‘ng loginWithEmail:",s),l("loginPassword",`Lá»—i há»‡ thá»‘ng: ${s.message}`),n&&(n.disabled=!1,n.textContent="ÄÄƒng nháº­p")}}async function U(){console.log("Login with Google called");try{const{data:o,error:t}=await a.auth.signInWithOAuth({provider:"google",options:{redirectTo:`${window.location.origin}/player.html`}});if(t)throw t;console.log("Google OAuth initiated:",o),a.auth.onAuthStateChange((n,e)=>{n==="SIGNED_IN"&&(e!=null&&e.user)&&(window.currentUser=e.user,window.dispatchEvent(new CustomEvent("SUPABASE_AUTH_CHANGE",{detail:{event:n,session:e}})))})}catch(o){console.error("Google login error:",o),alert("Lá»—i Ä‘Äƒng nháº­p Google: "+o.message)}}async function _(){try{console.log("Starting logout..."),localStorage.setItem("manh-music-logout","true"),localStorage.setItem("manh-music-logout-time",Date.now().toString());const o=3e3;let t=null;try{(await Promise.race([a.auth.signOut({scope:"local"}).then(()=>({success:!0})),new Promise(i=>setTimeout(()=>i({timeout:!0}),o))])).timeout?console.warn("signOut timed out"):console.log("Supabase signOut success")}catch(r){t=r,console.error("signOut error:",r)}Object.keys(localStorage).filter(r=>r.startsWith("sb-")||r.includes("supabase.auth")||r.includes("token")).forEach(r=>{localStorage.removeItem(r),console.log("Removed:",r)}),["cachedPlaylists","cachedHistoryTracks","cachedRecommendedTracks","cachedProfile","cachedPlaylistTracks","cachedRecommendationsPlaylistId"].forEach(r=>window[r]=null),window.userSessionLoaded=!1,console.log("Logout cleanup complete"),window.location.replace("/index.html")}catch(o){console.error("Lá»—i logout:",o),localStorage.setItem("manh-music-logout","true"),window.location.replace("/index.html")}}a.auth.onAuthStateChange((o,t)=>{var n;console.log("AUTH STATE CHANGED:",o,((n=t==null?void 0:t.user)==null?void 0:n.email)||"no user"),o==="SIGNED_IN"&&(t!=null&&t.user)&&(window.currentUser=t.user,(window.location.pathname.includes("index.html")||window.location.pathname==="/")&&(window.location.href="/player.html"),window.dispatchEvent(new CustomEvent("SUPABASE_AUTH_CHANGE",{detail:{event:o,session:t}}))),o==="SIGNED_OUT"&&(window.currentUser=null,window.location.href="/index.html")});window.authFunctions={signup:f,loginWithEmail:p,loginWithGoogle:U,logout:_};
