import{s as c}from"./client-CGC07Of8.js";if(!c)throw console.error("SUPABASE CLIENT NOT INITIALIZED! Check load order: client.js must load before auth.js"),new Error("Supabase client missing");console.log("Script loaded:",window.location.href);document.addEventListener("DOMContentLoaded",async function(){const e=window.location.pathname;console.log("Auth.js checking path:",e);try{console.log("Auth.js: Restoring session via getSession...");const{data:{session:n},error:u}=await c.auth.getSession();if(u)throw u;if(n!=null&&n.user){if(window.currentUser=n.user,console.log("Session restored:",n.user.email),window.dispatchEvent(new CustomEvent("SUPABASE_SESSION_RESTORED",{detail:{session:n}})),window.dispatchEvent(new CustomEvent("SUPABASE_AUTH_CHANGE",{detail:{event:"INITIAL_SESSION",session:n}})),e==="/"||e.includes("index.html")||e.includes("signup.html")){const r="/manh-music/";window.location.href=r+"player.html";return}}else if(console.warn("No session - show login form"),e.includes("player.html")){const r="/manh-music/";window.location.href=r+"index.html"}}catch(n){if(console.error("Session restore error:",n),e.includes("player.html")){const u="/manh-music/";window.location.href=u+"index.html"}}console.log("DOM fully loaded, searching for forms...");const o=document.getElementById("signupForm");o&&(console.log("FOUND signupForm"),o.addEventListener("submit",async n=>{n.preventDefault(),console.log("SIGNUP SUBMIT"),await p()}));const t=document.getElementById("loginForm");t&&(console.log("FOUND loginForm"),t.addEventListener("submit",async n=>{n.preventDefault(),console.log("LOGIN SUBMIT"),await E()}))});function a(e,o){const t=document.getElementById(`${e}Error`),n=document.getElementById(e);t&&n&&(t.textContent="",t.classList.remove("active"),n.classList.remove("error"),o&&(t.textContent=o,t.classList.add("active"),n.classList.add("error")))}function y(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}function P(e){return/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[\W_]).{8,}$/.test(e)}async function p(){const e=document.getElementById("signupUsername").value.trim(),o=document.getElementById("signupEmail").value.trim(),t=document.getElementById("signupPassword").value,n=document.getElementById("confirmPassword").value,u=document.getElementById("signupBirthday").value;a("signupUsername",null),a("signupEmail",null),a("signupPassword",null),a("confirmPassword",null),a("signupBirthday",null);let r=!1;if(e||(a("signupUsername","Vui lòng nhập Tên người dùng."),r=!0),o?y(o)||(a("signupEmail","Định dạng Email không hợp lệ."),r=!0):(a("signupEmail","Vui lòng nhập Email."),r=!0),t?P(t)||(a("signupPassword","Mật khẩu phải có ít nhất 8 ký tự, bao gồm chữ hoa, chữ thường, số và ký tự đặc biệt."),r=!0):(a("signupPassword","Vui lòng nhập Mật khẩu."),r=!0),n?t!==n&&(a("confirmPassword","Mật khẩu xác nhận không khớp."),r=!0):(a("confirmPassword","Vui lòng nhập lại Mật khẩu."),r=!0),u||(a("signupBirthday","Vui lòng nhập Ngày sinh."),r=!0),!r)try{const{count:i,error:d}=await c.from("users").select("username",{count:"exact"}).eq("username",e);if(d)throw new Error(`Lỗi kiểm tra tên người dùng: ${d.message}`);if(i>0){a("signupUsername","Tên người dùng này đã tồn tại.");return}const{data:m,error:g}=await c.auth.signUp({email:o,password:t,options:{data:{username:e,birthday:u}}});if(g){console.error("Signup error:",g),g.message.includes("already registered")?a("signupEmail","Email này đã được đăng ký."):a("signupEmail",`Đăng ký thất bại: ${g.message}`);return}console.log("Signup success:",m.user.email);const{error:s}=await c.from("users").upsert({id:m.user.id,email:o,username:e,birthday:u,avatar_url:null,updated_at:new Date().toISOString()});s?console.error("Upsert users error:",s):console.log("✅ Users table populated"),alert("Đăng ký thành công! Vui lòng kiểm tra email để xác nhận và đăng nhập.");const w="/manh-music/";window.location.href=w+"index.html";return}catch(i){console.error("Lỗi hệ thống khi đăng ký:",i),console.error("Exact error:",i.message),a("signupEmail",`Lỗi hệ thống: ${i.message}`)}}async function E(){var n,u,r;const e=document.getElementById("loginEmail").value,o=document.getElementById("loginPassword").value,t=document.querySelector('#loginForm button[type="submit"]')||document.getElementById("loginBtn");if(a("loginEmail",null),a("loginPassword",null),!e||!o){e||a("loginEmail","Vui lòng nhập Email."),o||a("loginPassword","Vui lòng nhập Mật khẩu.");return}t&&(t.disabled=!0,t.textContent="Đang đăng nhập...");try{console.log("Starting signInWithPassword for",e);const{data:{user:i},error:d}=await c.auth.signInWithPassword({email:e,password:o});if(d){console.error("Login error:",d);const l=d.message.includes("Invalid")?"Email hoặc mật khẩu không chính xác.":`Đăng nhập thất bại: ${d.message}`;a("loginPassword",l),t&&(t.disabled=!1,t.textContent="Đăng nhập");return}console.log("signIn success, user:",i.email);const{data:{session:m}}=await c.auth.getSession();if(window.currentUser=(m==null?void 0:m.user)||i,window.dispatchEvent(new CustomEvent("SUPABASE_SESSION_RESTORED",{detail:{session:m}})),window.dispatchEvent(new CustomEvent("SUPABASE_AUTH_CHANGE",{detail:{event:"SIGNED_IN",session:m}})),document.getElementById("loginEmail").value="",document.getElementById("loginPassword").value="",a("loginPassword","Đăng nhập thành công! Đang chuyển hướng..."),((n=i.app_metadata)==null?void 0:n.provider)==="email"&&!i.email_confirmed_at){alert("Email chưa xác nhận! Vui lòng kiểm tra mail."),t&&(t.disabled=!1,t.textContent="Đăng nhập");return}console.log("Email confirmed OK");const g=l=>new Promise((h,S)=>setTimeout(()=>S(new Error("Timeout")),l));let s=null;try{const{data:l,error:h}=await Promise.race([c.from("users").select("username, birthday, avatar_url").eq("id",i.id).single(),g(3e3)]);s=l,h&&h.code!=="PGRST116"&&console.error("Select profile error:",h)}catch(l){l.message!=="Timeout"&&console.warn("Select profile failed:",l)}const w=(s==null?void 0:s.username)||((u=i.user_metadata)==null?void 0:u.username)||e.split("@")[0],f=(s==null?void 0:s.birthday)||((r=i.user_metadata)==null?void 0:r.birthday)||null;try{await Promise.race([c.from("users").upsert({id:i.id,email:i.email,username:w,birthday:f,avatar_url:(s==null?void 0:s.avatar_url)||null,updated_at:new Date().toISOString()}),g(3e3)]),console.log("Profile upserted")}catch(l){l.message!=="Timeout"?console.warn("Upsert failed:",l):console.log("Upsert timeout - continue")}setTimeout(()=>{t&&(t.disabled=!1,t.textContent="Đăng nhập");const l="/manh-music/";window.location.href=l+"player.html"},300)}catch(i){console.error("Lỗi hệ thống loginWithEmail:",i),a("loginPassword",`Lỗi hệ thống: ${i.message}`),t&&(t.disabled=!1,t.textContent="Đăng nhập")}}async function I(){console.log("Login with Google called");try{const{data:e,error:o}=await c.auth.signInWithOAuth({provider:"google",options:{redirectTo:`${window.location.origin}/player.html`}});if(o)throw o;console.log("Google OAuth initiated:",e),c.auth.onAuthStateChange((t,n)=>{t==="SIGNED_IN"&&(n!=null&&n.user)&&(window.currentUser=n.user,window.dispatchEvent(new CustomEvent("SUPABASE_AUTH_CHANGE",{detail:{event:t,session:n}})))})}catch(e){console.error("Google login error:",e),alert("Lỗi đăng nhập Google: "+e.message)}}async function v(){try{console.log("Starting logout..."),localStorage.setItem("manh-music-logout","true"),localStorage.setItem("manh-music-logout-time",Date.now().toString());const e=3e3;let o=null;try{(await Promise.race([c.auth.signOut({scope:"local"}).then(()=>({success:!0})),new Promise(i=>setTimeout(()=>i({timeout:!0}),e))])).timeout?console.warn("signOut timed out"):console.log("Supabase signOut success")}catch(r){o=r,console.error("signOut error:",r)}Object.keys(localStorage).filter(r=>r.startsWith("sb-")||r.includes("supabase.auth")||r.includes("token")).forEach(r=>{localStorage.removeItem(r),console.log("Removed:",r)}),["cachedPlaylists","cachedHistoryTracks","cachedRecommendedTracks","cachedProfile","cachedPlaylistTracks","cachedRecommendationsPlaylistId"].forEach(r=>window[r]=null),window.userSessionLoaded=!1,console.log("Logout cleanup complete"),window.location.replace("/manh-music/"+"index.html")}catch(e){console.error("Lỗi logout:",e),localStorage.setItem("manh-music-logout","true"),window.location.replace("/manh-music/"+"index.html")}}c.auth.onAuthStateChange((e,o)=>{var t;if(console.log("AUTH STATE CHANGED:",e,((t=o==null?void 0:o.user)==null?void 0:t.email)||"no user"),e==="SIGNED_IN"&&(o!=null&&o.user)){if(window.currentUser=o.user,window.location.pathname.includes("index.html")||window.location.pathname==="/"){const n="/manh-music/";window.location.href=n+"player.html"}window.dispatchEvent(new CustomEvent("SUPABASE_AUTH_CHANGE",{detail:{event:e,session:o}}))}if(e==="SIGNED_OUT"){window.currentUser=null;const n="/manh-music/";window.location.href=n+"index.html"}});window.authFunctions={signup:p,loginWithEmail:E,loginWithGoogle:I,logout:v};
