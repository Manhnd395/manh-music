import{s as c}from"./client-CGC07Of8.js";import{c as se,r as ce}from"./ui-D2vW3j1y.js";import"./env-DhpaPper.js";import"./auth-BuM4aBJL.js";import"https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";console.log("App.js loaded");console.log("Supabase instance:",c?"Connected":"Not connected");console.log("Script loaded:",window.location.href);let s=null,m=!1,T=0,g=[],h=.5,y=!1,k="off",A=[],q=null,B=null,_=null,D=null,v=null,P=null,C=!1,$=!1,F=!1;window.isPlaying=m;window.currentUser=window.currentUser||null;window.appFunctions=window.appFunctions||{};console.log("‚úÖ appFunctions initialized");window.currentPlaylists=window.currentPlaylists||{};async function de(e){var o,n;const t=(o=e==null?void 0:e.detail)==null?void 0:o.session;if(console.log("SUPABASE_SESSION_RESTORED received in app.js:",!!(t!=null&&t.user),((n=t==null?void 0:t.user)==null?void 0:n.email)??null),t!=null&&t.user){window.currentUser=t.user;try{!window.appInitialized&&!window.initializationInProgress?(await L(t.user),window.appInitialized=!0):console.log("App already initialized or in progress; skipping initializeApp")}catch(r){console.error("Error initializing app after session restored:",r)}}else console.warn("No session after restore - redirecting to login if on protected page"),window.location.pathname.includes("player.html")&&(window.location.href="/index.html")}window.addEventListener("SUPABASE_SESSION_RESTORED",de);window.addEventListener("SUPABASE_AUTH_CHANGE",async e=>{var n;const{event:t,session:o}=e.detail||{};console.log("SUPABASE_AUTH_CHANGE in app.js:",t,((n=o==null?void 0:o.user)==null?void 0:n.email)??null),t==="SIGNED_IN"&&(o!=null&&o.user)?(window.currentUser=o.user,await L(o.user),window.appInitialized=!0):t==="SIGNED_OUT"&&(b==null||b())});window.addEventListener("load",()=>{!window.currentUser&&window.supabase&&(console.log("üîÑ App.js load fallback: Checking session"),window.supabase.auth.getUser().then(({data:{user:e}})=>{e&&!window.currentUser&&(window.currentUser=e,console.log("‚úÖ App.js fallback user set:",e.id),L(e))}))});window.addEventListener("beforeunload",()=>{q=null,B=null,_=null,D=null,v=null,P=null,window.playlistsLoadFlag=!1,console.log("üîÑ Cache reset for new tab")});function Q(){document.getElementById("playPauseBtn").addEventListener("click",R),document.getElementById("prevBtn").addEventListener("click",playPreviousTrack),document.getElementById("nextBtn").addEventListener("click",playNextTrack);const e=document.getElementById("volumeSlider");e&&e.addEventListener("input",ue),e&&(e.value=h*100),document.getElementById("progressBar").addEventListener("input",pe),document.getElementById("shuffleBtn").addEventListener("click",ve),document.getElementById("repeatBtn").addEventListener("click",Te),document.addEventListener("keydown",we),console.log("Player controls initialized")}window.initializePlayerControls=Q;window.closeModal=function(e){const t=document.getElementById(e);t?(t.style.display="none",console.log(`Modal ${e} closed.`)):console.warn(`Attempted to close non-existent modal: ${e}`)};window.addEventListener("error",function(e){console.error("üõë Global Error:",e.error),console.error("üõë Error at:",e.filename,"line:",e.lineno),e.error instanceof SyntaxError&&(console.warn("üîÑ Syntax error detected, attempting recovery..."),sessionStorage.clear())});if(window.location.hostname==="localhost"){const e="?v="+Date.now();document.querySelectorAll('script[type="module"][src*="/scripts/"]').forEach(t=>{t.src.includes("?")||(t.src+=e)})}c.auth.getSession().then(({data:{session:e},error:t})=>{window.currentUser||(console.log("üîÑ App.js: Force retry getSession after 500ms"),setTimeout(()=>{c.auth.getSession().then(({data:{session:o},error:n})=>{var r;console.log("üîÑ Force getSession result:",!!(o!=null&&o.user),((r=o==null?void 0:o.user)==null?void 0:r.email)||"null"),o!=null&&o.user&&!window.currentUser?(window.currentUser=o.user,console.log("‚úÖ App.js force session restored:",o.user.email),document.readyState==="complete"&&typeof L=="function"&&L(o.user)):n&&(console.error("Force getSession error:",n),localStorage.removeItem("sb-lezswjtnlsmznkgrzgmu-auth-token"))})},500))}).catch(e=>console.error("Force getSession failed:",e));function R(){if(console.log("üéµ togglePlayPause called, current state:",{isPlaying:m,hasAudio:!!s,isTransitioning:$}),$){console.log("‚è≥ Skipping - transition in progress");return}$=!0,setTimeout(()=>{$=!1},300);const e=document.getElementById("playPauseBtn");if(!s){console.log("‚ùå No audio element - cannot play"),g.length>0&&(console.log("üîÑ Attempting to play first track from playlist"),playTrack(g[T])),$=!1;return}const t=e?e.querySelector("i"):null;try{m?(console.log("‚è∏Ô∏è Pausing audio"),s.pause(),F=!0,setTimeout(()=>{F=!1},500),t&&(t.className="fas fa-play"),m=!1):(console.log("‚ñ∂Ô∏è Playing audio"),s.play().then(()=>{console.log("‚úÖ Play successful"),s.track&&window.updatePlayerBar(s.track),N()}).catch(o=>{if(console.error("‚ùå Play failed:",o),o.name==="AbortError"||o.message.includes("interrupted by a call to pause()")||F){console.warn("‚ö†Ô∏è Play interrupted - ignoring");return}console.log("üîÑ Attempting to reload audio"),s.load(),setTimeout(()=>{s.play().catch(n=>{console.error("‚ùå Final play attempt failed:",n),alert("Kh√¥ng th·ªÉ ph√°t nh·∫°c: "+n.message)})},100)}),t&&(t.className="fas fa-pause"),m=!0)}catch(o){console.error("‚ùå Error in togglePlayPause:",o),m=!1,t&&(t.className="fas fa-play")}}window.togglePlayPause=R;function ue(e){h=e.target.value/100,s&&(s.volume=h)}function pe(e){if(s&&s.duration){const t=e.target.value/100*s.duration;s.currentTime=t}}function we(e){if(e.target.tagName!=="INPUT")switch(e.code){case"Space":e.preventDefault(),R();break;case"ArrowLeft":e.preventDefault(),V(-10);break;case"ArrowRight":e.preventDefault(),V(10);break;case"ArrowUp":e.preventDefault(),fe();break;case"ArrowDown":e.preventDefault(),ge();break}}function V(e){s&&(s.currentTime+=e)}function fe(){h=Math.min(1,h+.1),s&&(s.volume=h);const e=document.getElementById("volumeSlider");e&&(e.value=h*100)}function ge(){h=Math.max(0,h-.1),s&&(s.volume=h);const e=document.getElementById("volumeSlider");e&&(e.value=h*100)}function N(){const e=document.getElementById("progressBar"),t=document.getElementById("currentTime"),o=document.getElementById("duration");if(s&&e){const n=s.currentTime/s.duration*100||0;e.value=n,t&&(t.textContent=W(s.currentTime)),o&&isFinite(s.duration)&&(o.textContent=W(s.duration))}}async function U(e,t=!1){const o="/assets/default-avatar.png",n=document.getElementById("userName"),r=document.getElementById("userAvatar"),a=document.getElementById("currentAvatarPreview");let i=await O(e.id);const l=(i==null?void 0:i.username)||"User Name";n&&(n.textContent=l);let d=o;if(i!=null&&i.avatar_url)if(i.avatar_url.includes("supabase.co")||i.avatar_url.startsWith("http"))d=i.avatar_url;else{const{data:f}=c.storage.from("avatars").getPublicUrl(i.avatar_url);f!=null&&f.publicUrl&&(d=f.publicUrl)}r&&(r.src=d),a&&(a.src=d);const u=document.getElementById("editUsername");u&&i&&(u.value=i.username||"");const w=document.getElementById("editBirthday");w&&i&&(w.value=i.birthday||"")}async function O(e){if(D)return D;const{data:t,error:o}=await c.from("users").select("username, birthday, avatar_url").eq("id",e).single();if(o)throw o;return D=t,t}window.loadProfile=O;function me(e){if(!e)return"/assets/default-avatar.png";if(e.includes("supabase.co")||e.startsWith("http"))return e;const{data:t}=c.storage.from("avatars").getPublicUrl(e);return(t==null?void 0:t.publicUrl)||"/assets/default-avatar.png"}async function ye(e,t){const o="avatars",n=t.name.split(".").pop(),r=`${e}/${Date.now()}_avatar.${n}`;try{console.log("Starting avatar upload to path:",r);const{data:a,error:i}=await c.storage.from(o).upload(r,t,{cacheControl:"3600",upsert:!0});if(i)return console.error("Upload error:",i),null;console.log("Upload data:",a);const{data:l}=c.storage.from(o).getPublicUrl(r);return console.log("Public URL:",l.publicUrl),l.publicUrl}catch(a){return console.error("System error during upload:",a),null}}function W(e){if(!e||isNaN(e))return"0:00";const t=Math.floor(e/60),o=Math.floor(e%60);return`${t}:${o.toString().padStart(2,"0")}`}window.playTrack=async function(e,t=g,o=-1){if(console.log("üéµ Attempting to play track:",e),!e||!e.file_url){console.error("‚ùå L·ªói: Th√¥ng tin track kh√¥ng h·ª£p l·ªá ho·∫∑c thi·∫øu file_url."),console.log("Track data:",e),alert("Kh√¥ng th·ªÉ ph√°t b√†i h√°t: File kh√¥ng t·ªìn t·∫°i");return}console.log("üìã Track details:",{title:e.title,artist:e.artist,file_url:e.file_url,has_file_url:!!e.file_url}),s&&(console.log("‚è∏Ô∏è Stopping previous audio"),s.pause(),s=null),t&&t.length>0&&(g=t,T=o!==-1?o:g.findIndex(r=>r.id===e.id)||0,y&&z());let n=e.file_url;console.log("üîó Original audio URL:",n),n&&n.includes("supabase.co")&&(n.includes("?")||(n+="?"),n+=`&t=${Date.now()}`,console.log("üîß Fixed Supabase URL:",n));try{try{const a=(await fetch(n,{method:"HEAD"})).headers.get("content-type")||"";if(console.log("üîé HEAD content-type for audioUrl:",a),a.includes("text/html")){console.error("‚ùå Audio URL points to HTML (likely a page), aborting play:",n),alert("Kh√¥ng th·ªÉ ph√°t b√†i h√°t: file tr·∫£ v·ªÅ HTML thay v√¨ file √¢m thanh. Ki·ªÉm tra file_url.");return}}catch(r){console.warn("‚ö†Ô∏è HEAD request failed, attempting range GET to probe content-type",r);try{const i=(await fetch(n,{method:"GET",headers:{Range:"bytes=0-1023"}})).headers.get("content-type")||"";if(console.log("üîé Range GET content-type for audioUrl:",i),i.includes("text/html")){console.error("‚ùå Audio URL points to HTML (via range GET), aborting play:",n),alert("Kh√¥ng th·ªÉ ph√°t b√†i h√°t: file tr·∫£ v·ªÅ HTML thay v√¨ file √¢m thanh. Ki·ªÉm tra file_url.");return}}catch(a){console.warn("‚ö†Ô∏è Probe request failed, continuing to create Audio (last resort)",a)}}s=new Audio(n),s.track=e,s.volume=h,s.preload="metadata",console.log("üéµ Audio element created"),s.addEventListener("loadeddata",function(){console.log("‚úÖ Audio loaded successfully:",e.title),N()}),s.addEventListener("canplay",function(){console.log("üé∂ Audio ready to play")}),s.addEventListener("error",function(r){console.error("‚ùå Audio load error:",r),console.error("Error details:",{error:s.error,networkState:s.networkState,readyState:s.readyState});let a="L·ªói t·∫£i file nh·∫°c: ";switch(s.error.code){case MediaError.MEDIA_ERR_ABORTED:a+="T·∫£i b·ªã h·ªßy";break;case MediaError.MEDIA_ERR_NETWORK:a+="L·ªói m·∫°ng";break;case MediaError.MEDIA_ERR_DECODE:a+="L·ªói ƒë·ªãnh d·∫°ng file";break;case MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED:a+="ƒê·ªãnh d·∫°ng kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£";break;default:a+="L·ªói kh√¥ng x√°c ƒë·ªãnh"}alert(a),s=null,m=!1}),s.addEventListener("timeupdate",N),s.addEventListener("ended",function(){console.log("‚èπÔ∏è Track ended:",e.title),m=!1;const r=document.getElementById("playPauseBtn"),a=r?r.querySelector("i"):null;a&&(a.className="fas fa-play"),g.length>0&&setTimeout(window.playNextTrack,500)}),s.load(),setTimeout(()=>{J(s,e)},100)}catch(r){console.error("‚ùå L·ªói t·∫°o audio element:",r),alert("L·ªói kh·ªüi t·∫°o tr√¨nh ph√°t nh·∫°c: "+r.message),s=null,m=!1}};window.playTrack=playTrack;async function J(e,t,o=0){try{console.log(`üéµ Attempting to play (retry ${o})...`),await e.play(),m=!0,window.updatePlayerBar(t);const r=document.getElementById("playPauseBtn"),a=r?r.querySelector("i"):null;a&&(a.className="fas fa-pause"),console.log("üé∂ Now playing:",t.title,"by",t.artist),he(t.id),typeof window.fetchLyrics=="function"&&window.fetchLyrics(t)}catch(r){console.error(`‚ùå Play failed (attempt ${o+1}):`,r),o<2?(console.log(`üîÑ Retrying play... (${o+1}/2)`),setTimeout(()=>J(e,t,o+1),500)):(console.error("‚ùå Max play retries exceeded"),alert("Kh√¥ng th·ªÉ ph√°t b√†i h√°t. C√≥ th·ªÉ file b·ªã l·ªói ho·∫∑c ƒë·ªãnh d·∫°ng kh√¥ng h·ªó tr·ª£."),m=!1,s=null)}}window.playNextTrack=async function(){if(k==="one"){window.appFunctions.playTrack(g[T]);return}if(g.length===0){if(console.log("No current playlist - loading recommendations for random next"),!window.currentUser)return;if(!_||_.length===0)try{const{data:i,error:l}=await c.rpc("get_unique_recommendations",{limit_count:20});if(l)throw l;_=i||[]}catch(i){console.error("L·ªói load recommendations for random:",i),m=!1;return}const n=_;if(n.length===0){console.log("No recommendations available - stopping playback"),m=!1;return}y||(y=!0,z(),console.log("Auto-enabled shuffle for recs fallback"));const r=Math.floor(Math.random()*n.length);g=n,T=r;const a=n[r];console.log(`Auto-playing random recommendation: ${a.title} (shuffled mode)`),window.appFunctions.playTrack(a);return}let e;if(y){let o=A.indexOf(T);o=(o+1)%g.length,e=A[o]}else e=(T+1)%g.length,A=[];T=e;const t=g[e];window.appFunctions.playTrack(t),setTimeout(()=>{const o=document.getElementById("playPauseBtn"),n=o?o.querySelector("i"):null;m&&n&&(n.className="fas fa-pause")},100)};window.playPreviousTrack=function(){if(g.length===0)return;T=(T-1+g.length)%g.length;const e=g[T];window.appFunctions.playTrack(e)};function I(e){if(!e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}async function he(e){var r;const t=window.currentUser;if(!t||!e)return;const o=t.id,n=new Date().toISOString();try{const{data:a,error:i}=await c.from("history").select("play_count").eq("user_id",o).eq("track_id",e).maybeSingle();if(i){console.error("L·ªói select history:",i);return}const l=((a==null?void 0:a.play_count)||0)+1,{error:d}=await c.from("history").upsert({user_id:o,track_id:e,play_count:l,played_at:n},{onConflict:"user_id,track_id"});if(d){console.error("L·ªói upsert history:",d);return}console.log(`History updated: ${l} l·∫ßn ph√°t cho track ${e}`),((r=document.getElementById("home-section"))==null?void 0:r.style.display)!=="none"&&setTimeout(()=>{var u;(u=window.renderPlayHistory)==null||u.call(window)},500)}catch(a){console.error("L·ªói h·ªá th·ªëng update history:",a)}}window.renderPlayHistory=async function(){await _e()};async function Y(e=!1){if(console.log("1. loadUserPlaylists STARTED",{forceRefresh:e}),!e&&window.playlistsLoadFlag){console.log("2. SKIP: already loaded");return}window.playlistsLoadFlag=!0;const t=window.currentUser;if(console.log("3. Using window.currentUser:",t?t.id:"NULL"),!t){console.error("5. NO USER ‚Üí STOPPING loadUserPlaylists"),window.playlistsLoadFlag=!1;return}const o=document.getElementById("playlistGrid");if(!o){console.error("7. playlistGrid NOT FOUND"),window.playlistsLoadFlag=!1;return}try{console.log("8. QUERYING playlists table...");const{data:n,error:r}=await te(()=>c.from("playlists").select("id, name, icon, color, cover_url").eq("user_id",t.id).order("created_at",{ascending:!1}));if(r)throw r;q=n||[],ce(n,o),console.log("11. renderPlaylists DONE")}catch(n){console.error("12. FINAL ERROR:",n),o.innerHTML='<p class="error-message">L·ªói t·∫£i playlist.</p>'}finally{window.playlistsLoadFlag=!1,console.log("13. loadUserPlaylists FINISHED")}}window.appFunctions.loadUserPlaylists=window.loadUserPlaylists;window.renderRecentHistory=async function(){const e=document.getElementById("historyTrackList");if(!e)return;const t=window.currentUser;if(!t){e.innerHTML='<p class="empty-message">Vui l√≤ng ƒëƒÉng nh·∫≠p.</p>';return}try{const{data:o,error:n}=await c.from("history").select(`
                track_id,
                played_at,
                tracks (
                    id, title, artist, cover_url, file_url
                )
            `).eq("user_id",t.id).order("played_at",{ascending:!1}).limit(5);if(n)throw n;if(!o||o.length===0){e.innerHTML='<p class="empty-message">Ch∆∞a c√≥ b√†i h√°t n√†o ƒë∆∞·ª£c ph√°t g·∫ßn ƒë√¢y.</p>';return}e.innerHTML=o.map((r,a)=>`
            <div class="track-item playable-track" onclick='event.stopPropagation(); window.playTrack(${JSON.stringify(r.tracks)}, [], -1)'>
                <div class="track-info">
                    <span class="track-index">${a+1}</span>
                    <img src="${r.tracks.cover_url||"/assets/default-cover.webp"}" 
                         class="track-cover" onerror="this.src='/assets/default-cover.webp'">
                    <div class="track-details">
                        <div class="track-name">${I(r.tracks.title)}</div>
                        <div class="track-artist">${I(r.tracks.artist)}</div>
                    </div>
                </div>
                <div class="track-actions">
                    <button class="btn-action" onclick="event.stopPropagation(); window.appFunctions.togglePlaylistDropdown(this, '${r.tracks.id}')">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
        `).join("")}catch(o){console.error("L·ªói t·∫£i l·ªãch s·ª≠ g·∫ßn ƒë√¢y:",o),e.innerHTML='<p class="error-message">L·ªói t·∫£i l·ªãch s·ª≠.</p>'}};window.loadTopTracks=async function(e=10){try{const{data:t,error:o}=await c.from("history").select(`
                track_id,
                play_count,
                tracks (
                    id,
                    title,
                    artist,
                    cover_url,
                    file_url
                )
            `).order("play_count",{ascending:!1}).limit(e);if(o)throw o;return t.sort((r,a)=>(a.play_count||0)-(r.play_count||0)).slice(0,e).map(r=>({...r.tracks,play_count:r.play_count||0}))}catch(t){return console.error("L·ªói t·∫£i top tracks:",t),[]}};window.renderRecommendations=async function(){const e=document.getElementById("recommendList");if(!e)return;e.innerHTML="<p>ƒêang t·∫£i g·ª£i √Ω...</p>";const t=await window.loadTopTracks(10);if(t.length===0){e.innerHTML='<p class="empty-message">Ch∆∞a c√≥ g·ª£i √Ω.</p>';return}e.innerHTML=t.map((o,n)=>`
        <div class="track-item playable-track" onclick='event.stopPropagation(); window.playTrack(${JSON.stringify(o)}, [], -1)'>
            <div class="track-info">
                <span class="track-index">${n+1}</span>
                <img src="${o.cover_url||"/assets/default-cover.webp"}" class="track-cover" onerror="this.src='/assets/default-cover.webp'">
                <div class="track-details">
                    <div class="track-name">${I(o.title)}</div>
                    <div class="track-artist">${I(o.artist)}</div>
                </div>
            </div>
            <div class="track-actions">
                <button class="btn-action" onclick="event.stopPropagation(); window.togglePlaylistDropdown(this, '${o.id}')">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </div>
    `).join("")};function Z(e){window.switchTab?window.switchTab("detail-playlist",e):console.error("Kh√¥ng t√¨m th·∫•y h√†m switchTab.")}window.appFunctions.openPlaylistDetail=Z;async function ee(e){var d;e.preventDefault();const t=e.target,o=t.querySelector("#playlistName"),n=t.querySelector("#playlistColor"),r=o?o.value.trim():null,a=n?n.value:"#1db954",i=(d=t.querySelector("#playlistCoverFile"))==null?void 0:d.files[0];if(!r){alert("T√™n danh s√°ch ph√°t kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.");return}const l=window.currentUser;if(!l){console.error("L·ªói: Ng∆∞·ªùi d√πng ch∆∞a ƒëƒÉng nh·∫≠p ho·∫∑c l·ªói x√°c th·ª±c!"),alert("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ t·∫°o danh s√°ch ph√°t!");return}try{const u={name:r,color:a,cover_url:null};if(i){const p=await uploadPlaylistCover(l.id,null,i);p&&(u.cover_url=p)}const w=await se(u);console.log("‚úÖ T·∫°o playlist th√†nh c√¥ng:",w),closeModal("createPlaylistModal"),window.cachedPlaylists=null,await window.appFunctions.loadUserPlaylists(!0);const f=localStorage.getItem("pendingTrackId");f&&w&&(await window.appFunctions.addTrackToPlaylist(f,w.id),localStorage.removeItem("pendingTrackId"),console.log("Auto-added pending track to new playlist"))}catch(u){console.error("‚ùå L·ªñI t·∫°o playlist:",u),alert("ƒê√£ x·∫£y ra l·ªói: "+u.message)}}window.handleCreatePlaylistSubmit=ee;function ve(){y=!y;const e=document.getElementById("shuffleBtn");e&&e.classList.toggle("active",y),ke(),console.log("Shuffle mode:",y?"ON":"OFF"),y&&g.length>1&&z()}function ke(){const e=document.getElementById("shuffleBtn");e&&(e.setAttribute("data-state",y?"on":"off"),e.style.color=y?"var(--primary-color)":"inherit")}function z(){const e=Array.from({length:g.length},(t,o)=>o);for(let t=e.length-1;t>0;t--){const o=Math.floor(Math.random()*(t+1));[e[t],e[o]]=[e[o],e[t]]}A=e}function Te(){k==="off"?k="all":k==="all"?k="one":k="off";const e=document.getElementById("repeatBtn");e&&e.classList.toggle("active",k!=="off"),X(),X(),console.log("Repeat mode:",k)}function X(){const e=document.getElementById("repeatBtn");e&&(e.setAttribute("data-mode",k),e.style.color=k!=="off"?"var(--primary-color)":"inherit")}window.deleteTrack=async function(e){if(confirm("X√≥a b√†i h√°t n√†y? Kh√¥ng th·ªÉ kh√¥i ph·ª•c!"))try{const{error:t}=await c.from("playlist_tracks").delete().eq("track_id",e);if(t)throw t;const{error:o}=await c.from("tracks").delete().eq("id",e);if(o)throw o;alert("ƒê√£ x√≥a b√†i h√°t!"),window.loadMyUploads(!0)}catch(t){console.error("L·ªói x√≥a:",t),alert("L·ªói: "+t.message)}};window.appFunctions.deleteTrack=window.deleteTrack;async function te(e,t=3,o=1e3){let n;for(let r=1;r<=t;r++)try{console.log(`Attempt ${r}/${t}`);const a=await e();if(a.error){if(console.error("Query returned error object:",a.error),a.error.code!=="PGRST116")throw a.error;return console.log("No rows found (PGRST116) - returning empty"),{data:null,error:null}}return console.log(`Query succeeded on attempt ${r}`),a}catch(a){if(n=a,console.warn(`Attempt ${r} failed:`,a),a!=null&&a.response&&console.warn("Response object:",a.response),r<t){const i=o*Math.pow(2,r-1);console.log(`Retrying in ${i}ms...`),await new Promise(l=>setTimeout(l,i))}}throw console.error("All retry attempts failed:",n),n}async function Le(){console.log("üß™ Testing Supabase connection...");const e=[{name:"Authentication",test:async()=>{if(!window.currentUser)throw new Error("No user logged in");return window.currentUser}},{name:"Database Read",test:async()=>{const n=await c.from("tracks").select("id").limit(1);if(n.error&&n.error.code!=="PGRST116")throw n.error;return n}},{name:"Storage Access",test:async()=>{const n=await c.storage.from("music-files").list("",{limit:1});if(n.error)throw n.error;return n}}],t=[];for(const n of e)try{const r=performance.now(),a=await n.test();console.log(`${n.name} raw result:`,a);const l=(performance.now()-r).toFixed(0);t.push({name:n.name,status:"‚úÖ",time:`${l}ms`}),console.log(`‚úÖ ${n.name}: ${l}ms`)}catch(r){t.push({name:n.name,status:"‚ùå",error:r.message}),console.error(`‚ùå ${n.name} failed:`,r.message)}return console.table(t),t.filter(n=>n.status==="‚ùå").length===0}function x(){const e=document.createElement("div");e.id="connectionWarning",e.innerHTML=`
        <div style="position: fixed; top: 10px; right: 10px; background: #ff6b6b; color: white; padding: 10px; border-radius: 5px; z-index: 10000; max-width: 300px;">
            <strong>‚ö†Ô∏è K·∫øt n·ªëi kh√¥ng ·ªïn ƒë·ªãnh</strong>
            <p style="margin: 5px 0; font-size: 12px;">M·ªôt s·ªë t√≠nh nƒÉng c√≥ th·ªÉ kh√¥ng ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng.</p>
            <button onclick="this.parentElement.remove()" style="background: white; border: none; padding: 2px 8px; border-radius: 3px; cursor: pointer;">ƒê√≥ng</button>
        </div>
    `,document.body.appendChild(e),setTimeout(()=>{e.parentElement&&e.remove()},1e4)}window.appFunctions={...window.appFunctions,loadAndOpenProfileModal:Ee,initializePlayerControls:Q,navigateTo:Ue,initProfileModal:ae,handleProfileSubmit:H,handleLogout:window.handleLogout,togglePlayPause:R,playTrack:window.playTrack,loadUserPlaylists:Y,loadHistoryTracks:be,playNextTrack:window.playNextTrack,playPreviousTrack:window.playPreviousTrack,searchTracks:window.searchTracks,loadMyUploads:window.loadMyUploads,loadPlaylistTracks:window.loadPlaylistTracks,openPlaylistDetail:Z,togglePlaylistDropdown:window.togglePlaylistDropdown,deleteTrack:window.deleteTrack,addTrackToPlaylist:window.appFunctions.addTrackToPlaylist,createNewPlaylist:window.appFunctions.createNewPlaylist,closeModal:window.closeModal,getCurrentUserId:ne};window.loadPlaylistTracks=async function(e,t=!1){if(!window.currentUser)return console.error("User kh√¥ng ƒëƒÉng nh·∫≠p, kh√¥ng t·∫£i tracks."),[];if(v&&v[e])return v[e];try{const{data:n,error:r}=await c.from("playlist_tracks").select("track_id, added_at").eq("playlist_id",e).order("added_at",{ascending:!0});if(r)throw console.error("L·ªói fetch playlist_items:",r),r;if(n.length===0){console.log(`Playlist ${e} tr·ªëng - no items.`);const u=[];return v||(v={}),v[e]=u,window.currentPlaylistSource="Playlist ID "+e,u}const a=n.map(u=>u.track_id),{data:i,error:l}=await c.from("tracks").select("id, title, artist, file_url, cover_url, user_id").in("id",a);if(l)throw console.error("L·ªói fetch tracks by IDs:",l),l;const d=i.map(u=>{const w=n.find(f=>f.track_id===u.id);return{...u,added_at:w?w.added_at:null}}).sort((u,w)=>{const f=new Date(u.added_at||0).getTime(),p=new Date(w.added_at||0).getTime();return f-p});return v||(v={}),v[e]=d,window.currentPlaylistSource="Playlist ID "+e,console.log(`T·∫£i ${d.length} tracks t·ª´ playlist ${e}:`,d.map(u=>u.title)),t&&d.length>0&&window.playTrack(d[0],d,0),d}catch(n){return console.error("L·ªói t·∫£i tracks playlist:",n),n.details&&console.log("Relationship details:",n.details),[]}};window.appFunctions.loadPlaylistTracks=window.loadPlaylistTracks;async function oe(){const e=window.currentUser;if(!e){console.warn("‚è≥ B·ªè qua testRLS ‚Äì ch∆∞a c√≥ user");return}console.log("üß™ Testing RLS Policies for user:",e.id);try{const{error:t}=await c.from("tracks").select("*").limit(1);console.log("Tracks SELECT:",t?+t.message:"‚úÖ OK");const{error:o}=await c.from("users").select("*").eq("id",e.id).single();console.log("Users SELECT:",o?+o.message:"‚úÖ OK")}catch(t){console.error("L·ªói testRLS:",t)}}async function ne(){const e=window.currentUser;return e==null?void 0:e.id}window.appFunctions.getCurrentUserId=ne;window.displayTracks=function(e,t){if(!t)return;t.innerHTML="";const o=t.id;e.forEach((n,r)=>{const a=document.createElement("div");a.className="track-item playable-track",a.trackData=n,a.addEventListener("click",function(p){p.target.closest(".btn-action")||(a.trackData&&window.appFunctions.playTrack&&(window.currentPlaylist=e,window.currentTrackIndex=r,window.appFunctions.playTrack(a.trackData,e,r)),p.preventDefault())});const i=(n.title||"").trim()||"B√†i h√°t kh√¥ng t√™n",l=(n.artist||"").trim()||"Ngh·ªá sƒ© kh√¥ng r√µ",d=i.length>15?`${i} ${i}`:i,u=l.length>15?`${l} ${l}`:l;console.log(`Display track ${r} (${o}):`,{id:n.id,title:n.title,artist:n.artist}),a.innerHTML=`
            <div class="track-index">${r+1}.</div>
            <img src="${n.cover_url||"/assets/default-cover.webp"}" alt="${i} by ${l}" class="track-cover" />
            <div class="track-info">
                <div class="track-details">
                    <strong class="track-name marquee-container">
                        <span class="track-title-inner">${d}</span>
                    </strong>
                    <small class="track-artist marquee-container">
                        <span class="track-artist-text">${u}</span>
                    </small>
                </div>
            </div>
          
            <div class="track-actions">
                <div class="playlist-add-container">
                    <button
                        class="btn-action btn-add-playlist"
                        data-track-id="${n.id}"
                        title="Th√™m v√†o playlist">
                        <i class="fa-solid fa-plus"></i>
                    </button>
                    <div class="playlist-dropdown" data-track-id="${n.id}">
                    </div>
                </div>
                ${o==="myUploadsList"?`
                    <button class="btn-action btn-delete-track"
                            onclick="event.stopPropagation(); window.appFunctions.deleteTrack('${n.id}')">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                `:""}
            </div>
        `;const w=a.querySelector(".track-name.marquee-container");if(w){const p=w.querySelector(".track-title-inner");p&&p.scrollWidth>w.clientWidth&&p.classList.add("marquee")}const f=a.querySelector(".track-artist.marquee-container");if(f){const p=f.querySelector(".track-artist-text");p&&p.scrollWidth>f.clientWidth&&p.classList.add("marquee")}t.appendChild(a)}),t.dataset.delegationAttached||(t.addEventListener("click",function(n){const r=n.target.closest(".btn-add-playlist");if(r){n.stopPropagation(),n.stopImmediatePropagation();const a=r.dataset.trackId;if(a){window.dropdownDebounce||(window.dropdownDebounce={});const i=`toggle_${a}`;if(window.dropdownDebounce[i])return;window.dropdownDebounce[i]=!0,setTimeout(()=>{delete window.dropdownDebounce[i]},200),console.log("Toggle dropdown cho track (delegated):",a),window.appFunctions.togglePlaylistDropdown(r,a)}}}),t.dataset.delegationAttached="true",console.log(`Event delegation attached for container ${o}`)),console.log(`Displayed ${e.length} tracks in ${o} - Check console for data`)};async function re(e){const t=document.getElementById("searchList");if(!t)return;if(!e||e.length<3){t.innerHTML='<p class="empty-message">Nh·∫≠p t·ª´ kh√≥a ƒë·ªÉ b·∫Øt ƒë·∫ßu t√¨m ki·∫øm.</p>';return}let o=c.from("tracks").select(`
            id, 
            title, 
            artist, 
            file_url,
            cover_url,
            users!user_id (username)
        `);o=o.or(`title.ilike.%${e}%,artist.ilike.%${e}%`);const{data:n,error:r}=await o.limit(10);if(r){console.error("L·ªói t√¨m ki·∫øm:",r),t.innerHTML=`<p class="error-message">L·ªói khi t√¨m ki·∫øm: ${r.message}</p>`;return}window.displayTracks(n,t)}window.searchTracks=re;window.appFunctions.searchTracks=re;async function ae(){const e=window.currentUser;if(!e){console.log("No user logged in");return}console.log("Fetching profile for user ID:",e.id);let{data:t,error:o}=await c.from("users").select("username, birthday, avatar_url").eq("id",e.id).single();if(o)if(console.error("Select error:",o),alert("L·ªói select profile: "+o.message+" (Check RLS for SELECT policy)"),o.code==="PGRST116"){console.log("No profile - inserting default");const d=e.email?e.email.split("@")[0]:"New User",{data:u,error:w}=await c.from("users").insert([{id:e.id,email:e.email||"noemail@example.com",username:d,birthday:null,avatar_url:null,updated_at:new Date().toISOString()}]).select("username, birthday, avatar_url").single();if(w){console.error("Insert error:",w),alert("L·ªói insert profile: "+w.message+" (Check RLS for INSERT policy)");return}t=u}else return;console.log("Profile data:",t),document.getElementById("editEmail").value=e.email||"Ch∆∞a c√≥ email";let r=t.avatar_url?me(t.avatar_url):"/assets/default-avatar.png",a=t.username||(e.email?e.email.split("@")[0]:"User Name"),i=t.birthday||"";document.getElementById("editUsername").value=a,document.getElementById("editBirthday").value=i;const l=document.getElementById("currentAvatarPreview");l&&(l.src=r),window.cachedProfile=t,U(e)}window.initProfileModal=ae;async function H(e){e.preventDefault(),console.log("Form submit triggered");const t=document.getElementById("saveProfileBtn"),o=window.currentUser;if(!o)return;const n=document.getElementById("editUsername").value.trim(),r=document.getElementById("editBirthday").value||null,a=document.getElementById("avatarFile").files[0];if(!n){alert("T√™n ng∆∞·ªùi d√πng b·∫Øt bu·ªôc!");return}if(r&&isNaN(Date.parse(r))){alert("Ng√†y sinh format sai!");return}const i=await O(o.id);let l=(i==null?void 0:i.avatar_url)||null;if(t.textContent="ƒêang l∆∞u...",t.disabled=!0,a){const E=await ye(o.id,a);if(!E){alert("L·ªói upload avatar - check console"),t.textContent="L∆∞u Thay ƒê·ªïi",t.disabled=!1;return}l=E}const d={email:o.email||"noemail@example.com",username:n,birthday:r,avatar_url:l||null};console.log("Preparing save with:",d);const{count:u,error:w}=await c.from("users").select("count",{count:"exact"}).eq("id",o.id);if(w){console.error("Count error:",w),alert("L·ªói check profile: "+w.message+" (Check RLS for SELECT)"),t.textContent="L∆∞u Thay ƒê·ªïi",t.disabled=!1;return}let f,p;if(u>0?(console.log("Row exists - updating"),{data:f,error:p}=await c.from("users").update(d).eq("id",o.id).select()):(console.log("No row - inserting"),{data:f,error:p}=await c.from("users").insert([{id:o.id,...d}]).select()),p){console.error("Save error:",p),alert("L·ªói save: "+p.message+" (Check RLS for UPDATE/INSERT)"),t.textContent="L∆∞u Thay ƒê·ªïi",t.disabled=!1;return}f.length>0?(console.log("Save success, returned data:",f),alert("L∆∞u th√†nh c√¥ng!")):(console.log("Save no row affected"),alert("Kh√¥ng c√≥ thay ƒë·ªïi (RLS may block or values same)")),window.cachedProfile=null,U(o,!0),t.textContent="L∆∞u Thay ƒê·ªïi",t.disabled=!1,closeModal("profileModal")}async function Ee(){const e=document.getElementById("profileModal"),t=document.getElementById("modalContentContainer");if(window.cachedProfile=null,!t||!e){console.error("Kh√¥ng t√¨m th·∫•y Modal ho·∫∑c Container.");return}const o='<div style="padding: 20px; text-align: center;">ƒêang t·∫£i th√¥ng tin c√° nh√¢n...</div>';if(t.innerHTML=o,e.style.display="flex",t.innerHTML===o)try{const r=await fetch("/profile.html");if(!r.ok)throw new Error("Kh√¥ng th·ªÉ t·∫£i profile.html");t.innerHTML=await r.text();const a=document.getElementById("profileEditForm");a&&typeof H=="function"?(a.removeEventListener("submit",H),a.addEventListener("submit",H),console.log("Submit listener attached successfully to profileEditForm")):console.error('L·ªói: Kh√¥ng t√¨m th·∫•y form ID="profileEditForm" ho·∫∑c h√†m handleProfileSubmit.');const i=document.getElementById("avatarFile");i&&i.addEventListener("change",l=>{const d=l.target.files[0];if(d){const u=URL.createObjectURL(d);document.getElementById("currentAvatarPreview").src=u,console.log("Avatar local preview set")}})}catch(r){console.error("L·ªói t·∫£i Profile Modal HTML:",r),t.innerHTML='<p style="padding: 20px;">L·ªói t·∫£i giao di·ªán. Vui l√≤ng th·ª≠ l·∫°i.</p>';return}typeof window.initProfileModal=="function"?await window.initProfileModal():console.warn("H√†m initProfileModal ch∆∞a ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a."),window.currentUser||(t.innerHTML='<p style="padding: 20px;">Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i ƒë·ªÉ xem th√¥ng tin c√° nh√¢n.</p>')}async function be(e=!1){const t=window.currentUser,o=document.getElementById("historyTrackList");if(!(!t||!o)){if(B&&!e){const n=B.map(r=>r.tracks);window.displayTracks&&window.displayTracks(n,o);return}o.innerHTML="<p>ƒêang t·∫£i l·ªãch s·ª≠...</p>";try{const{data:n,error:r}=await c.from("history").select(`
                track_id, 
                played_at, 
                tracks (id, title, artist, file_url, cover_url) 
            `).eq("user_id",t.id).order("played_at",{ascending:!1}).limit(20);if(r)throw r;if(B=n,o.innerHTML="",n.length===0)o.innerHTML='<p class="empty-message">B·∫°n ch∆∞a ph√°t b√†i h√°t n√†o g·∫ßn ƒë√¢y.</p>';else{const a=n.map(i=>i.tracks);window.displayTracks&&window.displayTracks(a,o)}}catch(n){console.error("L·ªói t·∫£i l·ªãch s·ª≠:",n),o.innerHTML='<p class="error-message">L·ªói t·∫£i l·ªãch s·ª≠ ph√°t nh·∫°c.</p>'}}}window.openCreatePlaylistModal=function(){console.log("--- B·∫Øt ƒë·∫ßu m·ªü modal t·∫°o playlist ---");const e=document.getElementById("createPlaylistModal");if(e){e.style.display="flex";const t=document.getElementById("createPlaylistForm");if(t){const o=window.handleCreatePlaylistSubmit||ee;if(typeof o!="function"){console.error("L·ªói: handleCreatePlaylistSubmit ch∆∞a ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a ho·∫∑c ch∆∞a ƒë∆∞·ª£c g·∫Øn v√†o window.");return}t.removeEventListener("submit",o),t.addEventListener("submit",o),console.log("Form submit listener attached.")}else console.error('L·ªói: Kh√¥ng t√¨m th·∫•y form ID="createPlaylistForm".')}else console.error('L·ªói: Kh√¥ng t√¨m th·∫•y modal ID="createPlaylistModal".')};window.renderTrackItem=function(e,t,o){const n=document.createElement("div");n.className="track-item playable-track",n.dataset.trackId=e.id;const r=(e.title||"Unknown Title").trim(),a=(e.artist||"Unknown Artist").trim(),i=e.cover_url||"/assets/default-cover.webp";return n.innerHTML=`
        <div class="track-info">
            <span class="track-index">${t+1}</span>
            <img src="${i}" alt="${r}" class="track-cover" 
                 onerror="this.src='/assets/default-cover.webp'">
            <div class="track-details">
                <div class="track-name marquee-container">
                    <span class="track-title-inner">${r}</span>
                </div>
                <div class="track-artist">${a}</div>
            </div>
        </div>
        <div class="track-actions">
            <div class="playlist-add-container">
                <button class="btn-action" 
                        onclick="appFunctions.togglePlaylistDropdown(this, '${e.id}')"
                        title="Th√™m v√†o playlist">
                    <i class="fas fa-plus"></i>
                </button>
                <div class="playlist-dropdown"></div>
            </div>

            <!-- N√öT X√ìA - CH·ªà HI·ªÜN ·ªû UPLOADS -->
            ${o==="myUploadsList"?`
            <button class="btn-action text-danger" 
                    onclick="event.stopPropagation(); deleteTrack('${e.id}')" 
                    title="X√≥a b√†i h√°t">
                <i class="fas fa-trash"></i>
            </button>`:""}
        </div>
    `,n.addEventListener("click",l=>{var u;if(l.target.closest(".btn-action"))return;const d=((u=window.currentPlaylists)==null?void 0:u[o])||[];window.playTrack(e,d,t)}),setTimeout(()=>{const l=n.querySelector(".track-title-inner"),d=n.querySelector(".marquee-container");l&&d&&l.scrollWidth>d.clientWidth&&l.classList.add("marquee")},100),n};window.renderTrackList=function(e,t){const o=document.getElementById(t);if(o){if(o.innerHTML="",window.currentPlaylists=window.currentPlaylists||{},window.currentPlaylists[t]=e,e.length===0){o.innerHTML='<p class="empty-message">Kh√¥ng c√≥ b√†i h√°t</p>';return}e.forEach((n,r)=>{const a=window.renderTrackItem(n,r,t);o.appendChild(a)}),console.log(`Displayed ${e.length} tracks in ${t}`)}};window.loadMyUploads=async function(e=!1){const t=document.getElementById("myUploadsList");if(!t)return;if((e||!P||P.length===0)&&(P=null,console.log("Cache invalidated for uploads")),P&&!e){window.displayTracks(P,t);return}t.innerHTML="<p>ƒêang t·∫£i danh s√°ch b√†i h√°t...</p>";const o=window.currentUser;if(!o){console.error("No user session for uploads"),t.innerHTML='<p class="error-message">Vui l√≤ng ƒëƒÉng nh·∫≠p.</p>';return}try{console.log("üîÑ Loading uploads for user:",o.id);const{data:n,error:r}=await te(()=>c.from("tracks").select("*, users!user_id (username)").eq("user_id",o.id).order("uploaded_at",{ascending:!1}));if(r)throw r;if(P=n||[],console.log(`‚úÖ Loaded ${n.length} uploads`),n.length===0){t.innerHTML='<p class="empty-message">B·∫°n ch∆∞a t·∫£i l√™n b√†i h√°t n√†o.</p>';return}window.displayTracks(n,t)}catch(n){console.error("‚ùå L·ªói t·∫£i uploads sau t·∫•t c·∫£ retry:",n),t.innerHTML=`<p class="error-message">L·ªói khi t·∫£i: ${n.message}</p>`}};window.loadHomePage=async function(){var t;if(console.log("CALL loadHomePage, currentUser:",window.currentUser,"at",performance.now()),C){console.log("Home page already loaded, skipping");return}const e=document.getElementById("mainContentArea");if(!e){console.error("No mainContentArea for home page");return}try{console.log("Starting loadHomePage..."),C=!0;const o=await fetch("/home-content.html");if(!o.ok)throw new Error("Kh√¥ng th·ªÉ t·∫£i home-content.html");const n=await o.text();e.innerHTML=n,console.log("Home content loaded"),await new Promise(r=>{let a=0;const i=setInterval(()=>{const l=document.getElementById("playlistGrid"),d=document.getElementById("historyTrackList"),u=document.getElementById("recommendList");d&&u?(clearInterval(i),console.log("All home containers ready - proceeding sequential loads"),r()):a++>10&&(console.warn("Some containers timeout - partial load proceeding"),clearInterval(i),r())},300)}),console.log("Loading home page data sequentially..."),console.log("Step 1: Loading playlists..."),(t=window.appFunctions)!=null&&t.loadUserPlaylists&&(await window.appFunctions.loadUserPlaylists(),console.log("Playlists loaded")),console.log("Step 2: Loading recent history..."),window.renderRecentHistory&&(await window.renderRecentHistory(),console.log("Recent history loaded (5 tracks)")),console.log("Step 3: Loading recommendations..."),window.renderRecommendations&&(await window.renderRecommendations(),console.log("Recommendations loaded (10 tracks)")),console.log("All home components ready")}catch(o){console.error("L·ªói t·∫£i giao di·ªán Trang Ch·ªß:",o),C=!1,e.innerHTML=`
            <div class="error-message">
                <h3>L·ªói t·∫£i trang ch·ªß</h3>
                <p>${o.message}</p>
                <button onclick="window.loadHomePage()" class="btn-retry">Th·ª≠ l·∫°i</button>
            </div>
        `}};window.handleLogout=async function(){console.log("ƒêƒÉng xu·∫•t");try{await window.authFunctions.logout()}catch(e){console.error("L·ªói khi ƒëƒÉng xu·∫•t:",e)}alert("B·∫°n mu·ªën ƒëƒÉng xu·∫•t?"),window.currentUser=null,b()};window.appFunctions.handleLogout=window.handleLogout;async function Pe(){try{const e=window.currentUser;if(!e)return null;const{data:t,error:o}=await c.from("history").select("track_id, played_at, tracks(id, title, artist, cover_url, file_url)").eq("user_id",e.id).order("played_at",{ascending:!1}).limit(1);return o?(console.warn("L·ªói query history:",o.message),null):!t||t.length===0?(console.log("Kh√¥ng c√≥ l·ªãch s·ª≠ ph√°t"),null):{track:t[0].tracks,played_at:t[0].played_at}}catch(e){return console.error("L·ªói getRecentTrack:",e),null}}async function Se(){const e=await Pe();if(!(e!=null&&e.track)){console.log("Kh√¥ng c√≥ b√†i h√°t g·∫ßn ƒë√¢y ƒë·ªÉ resume");return}let t=0;const o=15,n=async()=>{var r;if(window.updatePlayerBar&&document.getElementById("playerBar")){const a=await((r=window.getRecommendationsAsPlaylist)==null?void 0:r.call(window))||[],i=a.findIndex(l=>l.id===e.track.id);window.playTrack(e.track,a,i>=0?i:0),console.log(`ƒê√£ resume: "${e.track.title}"`);return}t<o?(t++,setTimeout(n,300)):console.warn("Player bar kh√¥ng s·∫µn s√†ng sau 4.5s")};n()}window.togglePlaylistDropdown=async function(e,t){console.log("Toggle dropdown cho track:",t);const o=e.closest(".playlist-add-container");if(!o)return console.error("Kh√¥ng t√¨m th·∫•y .playlist-add-container");const n=o.querySelector(".playlist-dropdown");if(!n)return console.error("Kh√¥ng t√¨m th·∫•y .playlist-dropdown");if(document.querySelectorAll(".playlist-dropdown.active").forEach(a=>{a!==n&&(a.classList.remove("active"),document.body.classList.remove("dropdown-open"),console.log("Closed other dropdown"))}),n.classList.contains("active"))n.classList.remove("active"),document.body.classList.remove("dropdown-open"),document.removeEventListener("click",window.outsideClickHandler),n.removeEventListener("mouseleave",window.mouseLeaveHandler),console.log(`Dropdown state: on ‚Üí off for ${t}`);else{const a=e.getBoundingClientRect(),i=0,l=220;let d=a.right+window.scrollX+i,u="right";const w=window.innerWidth+window.scrollX-20;d+l>w&&(d=a.left+window.scrollX-i-l,u="left-flip",console.log("Off-screen detected: Flipped to left align (left="+d+")")),n.style.top=`${a.bottom+window.scrollY+i}px`,n.style.left=`${d}px`,n.style.width=`${l}px`,n.style.right="auto",n.style.height="auto",n.classList.add("active"),document.body.classList.add("dropdown-open"),console.log(`Dropdown after active: display=${getComputedStyle(n).display}, opacity=${getComputedStyle(n).opacity}, position=${getComputedStyle(n).position}, bg=${getComputedStyle(n).backgroundColor}, z=${getComputedStyle(n).zIndex}`),console.log(`Rect after: top=${n.getBoundingClientRect().top}, left=${n.getBoundingClientRect().left}, width=${n.getBoundingClientRect().width}, height=${n.offsetHeight}px, visible=${n.offsetHeight>0}, align=${u}`),n.innerHTML="";try{const f=window.currentUser;if(!f)n.innerHTML='<div class="empty-message">ƒêƒÉng nh·∫≠p ƒë·ªÉ th√™m playlist</div>';else{let p=window.cachedPlaylists||[];if(p.length===0){const{data:S,error:M}=await c.from("playlists").select("id, name, color").eq("user_id",f.id).order("created_at",{ascending:!1});if(M)throw M;p=S||[],window.cachedPlaylists=p,console.log(`Fetched & cached ${p.length} playlists`)}else console.log(`Using cached ${p.length} playlists`);let E="";p.length===0?E=`<div class="playlist-option create-new" onclick="appFunctions.createNewPlaylist('${t}'); event.stopPropagation(); event.preventDefault(); closeDropdown('${t}');"> + T·∫°o playlist m·ªõi </div>`:(p.forEach(S=>{E+=`<div class="playlist-option" style="border-left: 3px solid ${S.color||"#1DB954"};" onclick="appFunctions.addTrackToPlaylist('${t}', '${S.id}'); event.stopPropagation(); event.preventDefault(); closeDropdown('${t}');"> ${S.name} </div>`}),E+=`<div class="playlist-option create-new" onclick="appFunctions.createNewPlaylist('${t}'); event.stopPropagation(); event.preventDefault(); closeDropdown('${t}');"> + T·∫°o playlist m·ªõi </div>`),n.innerHTML=E,console.log(`HTML set: ${E.substring(0,100)}...`),n.style.height="auto",n.offsetHeight,console.log(`Reflow triggered: new height=${n.offsetHeight}px`)}n.dataset.loaded="true"}catch(f){console.error("L·ªói load playlist dropdown:",f),n.innerHTML='<div class="error-message">L·ªói t·∫£i playlist</div>',n.offsetHeight}window.mouseLeaveHandler=()=>{setTimeout(()=>{n.classList.remove("active"),document.body.classList.remove("dropdown-open"),document.removeEventListener("click",window.outsideClickHandler),n.removeEventListener("mouseleave",window.mouseLeaveHandler),console.log(`Closed on mouse leave for ${t}`)},200)},n.addEventListener("mouseleave",window.mouseLeaveHandler),window.outsideClickHandler=f=>{!n.contains(f.target)&&!e.contains(f.target)&&(n.classList.remove("active"),document.body.classList.remove("dropdown-open"),document.removeEventListener("click",window.outsideClickHandler),n.removeEventListener("mouseleave",window.mouseLeaveHandler),console.log(`Closed on outside click for ${t}`))},document.addEventListener("click",window.outsideClickHandler),console.log(`Dropdown state: off ‚Üí on (under-right fixed, align=${u}) for ${t}`)}};window.appFunctions.togglePlaylistDropdown=window.togglePlaylistDropdown;window.closeDropdown=function(e){const t=document.querySelector(`.playlist-add-container [data-track-id="${e}"]`).closest(".playlist-add-container");if(t){const o=t.querySelector(".playlist-dropdown");o&&(o.classList.remove("active"),document.body.classList.remove("dropdown-open"),console.log(`Closed dropdown for ${e}`))}};window.appFunctions.addTrackToPlaylist=async function(e,t){try{const{data:o}=await c.from("playlist_tracks").select("id").eq("playlist_id",t).eq("track_id",e).limit(1);if((o==null?void 0:o.length)>0){alert("B√†i h√°t ƒë√£ c√≥ trong playlist!");return}const{error:n}=await c.from("playlist_tracks").insert({playlist_id:t,track_id:e});if(n)throw n;if(alert("ƒê√£ th√™m v√†o playlist!"),window.loadDetailPlaylist){const r=document.getElementById("playlistDetail");r&&r.dataset.playlistId===t&&window.loadDetailPlaylist(t)}}catch(o){console.error("L·ªói th√™m:",o),alert("L·ªói: "+o.message)}};window.appFunctions.createNewPlaylist=function(e){localStorage.setItem("pendingTrackId",e);const t=document.getElementById("createPlaylistModal");t&&(t.style.display="flex")};async function _e(){const e=document.getElementById("historyTrackList");if(e)try{const t=window.currentUser;if(!t)return;const{data:o,error:n}=await c.from("history").select(`
                track_id,
                played_at,
                tracks (
                    id, title, artist, cover_url, file_url
                )
            `).eq("user_id",t.id).order("played_at",{ascending:!1}).limit(5);if(n)throw n;if(!o||o.length===0){e.innerHTML='<p class="empty-message">Ch∆∞a c√≥ b√†i h√°t n√†o ƒë∆∞·ª£c ph√°t g·∫ßn ƒë√¢y.</p>';return}e.innerHTML=o.map((r,a)=>`
            <div class="track-item playable-track" onclick='event.stopPropagation(); window.playTrack(${JSON.stringify(r.tracks)}, [], -1)'>
                <div class="track-info">
                    <span class="track-index">${a+1}</span>
                    <img src="${r.tracks.cover_url||"/assets/default-cover.webp"}" 
                         alt="Cover" class="track-cover" 
                         onerror="this.src='/assets/default-cover.webp'">
                    <div class="track-details">
                        <div class="track-name">${I(r.tracks.title)}</div>
                        <div class="track-artist">${I(r.tracks.artist)}</div>
                    </div>
                </div>
                <div class="track-actions">
                    <button class="btn-action" onclick="event.stopPropagation(); window.appFunctions.togglePlaylistDropdown(this, '${r.tracks.id}')">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
        `).join(""),console.log(`Loaded ${o.length} recent tracks`)}catch(t){console.error("L·ªói t·∫£i l·ªãch s·ª≠:",t),e.innerHTML='<p class="error-message">L·ªói t·∫£i l·ªãch s·ª≠.</p>'}}window.testAllTrackUrls=async function(){const{data:e,error:t}=await c.from("tracks").select("id, title, file_url");if(t){console.error("‚ùå Error fetching tracks:",t);return}console.log("üîç Testing URLs for",e.length,"tracks");for(const o of e){const n=await window.testAudioUrl(o.id);console.log(`${n?"‚úÖ":"‚ùå"} ${o.title}: ${o.file_url}`),await new Promise(r=>setTimeout(r,100))}};window.switchTab=function(e,t=null){console.log("switchTab called:",e,t),document.querySelectorAll(".page-section").forEach(r=>{r.style.display="none"});let o;e==="home"?o="home-section":e==="detail-playlist"?o="playlistDetail":e==="search"?o="search-section":e==="uploads"?o="myUploadsSection":e==="profile"?o="profile-section":e==="recommend"&&(o="recommend-section");const n=document.getElementById(o);n?(n.style.display="block",console.log(`Switched to: ${o}`)):console.warn(`Section not found: ${o}`),e==="detail-playlist"&&t&&setTimeout(()=>{window.loadDetailPlaylist&&window.loadDetailPlaylist(t)},100),document.querySelectorAll(".sidebar-link").forEach(r=>{r.classList.remove("active"),r.dataset.tab===e&&r.classList.add("active")})};async function L(e){if(window.appInitialized||window.initializationInProgress){console.log("‚è≥ App already initialized or in progress, skipping");return}if(!e){console.error("‚ùå initializeApp called without user");return}window.initializationInProgress=!0,window.currentUser=e,console.log(" Initializing app for user:",e.email||e.id),console.log("üß™ Testing connection...");const t=await Le();await oe(),t?console.log("‚úÖ All connection tests passed"):(console.error("üö® Connection tests failed - showing warning"),x());try{await U(e),await window.loadHomePage(),await window.switchTab("home"),await Y(!0),window.userSessionLoaded||(window.userSessionLoaded=!0,await Se(e)),window.appInitialized=!0,console.log("‚úÖ App fully initialized")}catch(o){console.error("‚ùå App initialization failed:",o),x==null||x()}finally{window.initializationInProgress=!1}}function b(){console.log("üîÑ Resetting all caches for fresh start"),q=null,B=null,_=null,D=null,v=null,P=null,window.playlistsLoadFlag=!1}document.addEventListener("DOMContentLoaded",async()=>{console.log("üì¶ DOM Content Loaded");const{data:{session:e}}=await c.auth.getSession();if(console.log("SESSION AT DOMContentLoaded:",e,"at",performance.now()),e!=null&&e.user?(window.currentUser=e.user,window.appInitialized?console.log("‚è≥ App ƒë√£ init tr∆∞·ªõc ƒë√≥, b·ªè qua DOMContentLoaded"):(await L(e.user),window.appInitialized=!0)):(console.warn("‚ö†Ô∏è No active session - but NOT redirecting (debug mode); force getUser"),c.auth.getUser().then(({data:{user:o},error:n})=>{o?(window.currentUser=o,console.log("‚úÖ DOMLoaded force getUser success:",o.id),L(o)):(console.error("getUser also failed:",n),window.location.href="/index.html")})),window.appInitialized){console.log("üîÑ App already initialized, skipping DOMContentLoaded");return}if(window._oauthEarlyUser){console.log("üîÅ Found early OAuth user on DOMContentLoaded:",window._oauthEarlyUser.id);try{await L(window._oauthEarlyUser),window._oauthEarlyUser=null,window.appInitialized=!0;return}catch(o){console.error("‚ùå Error initializing app with early OAuth user:",o),window.appInitialized=!1}}const t=window.location.hash.substring(1);if(t){const o=new URLSearchParams(t),n=o.get("access_token"),r=o.get("refresh_token");if(n&&r)try{console.log("üîë Found OAuth tokens in URL ‚Äî setting Supabase session...");const{data:{session:a},error:i}=await c.auth.setSession({access_token:n,refresh_token:r});if(i){console.error("‚ùå Set session error:",i),window.location.href="/index.html";return}if(!(a!=null&&a.user)){console.warn("‚ö†Ô∏è setSession returned session without user"),window.location.href="/index.html";return}console.log("‚úÖ Session established from OAuth for:",a.user.email),history.replaceState({},document.title,window.location.pathname),await L(a.user),window.appInitialized=!0;return}catch(a){console.error("‚ùå OAuth processing error:",a),window.location.href="/index.html";return}}try{const{data:{session:o},error:n}=await c.auth.getSession();if(n&&console.error("‚ùå Session retrieval error:",n),o!=null&&o.user){console.log("‚úÖ Existing session found:",o.user.email),await L(o.user),window.appInitialized=!0;return}else{console.warn("‚ö†Ô∏è No active session found ‚Äî redirecting to login"),window.location.href="/index.html";return}}catch(o){console.error("‚ùå Error checking existing session:",o),window.location.href="/index.html";return}});c.auth.onAuthStateChange(async(e,t)=>{var o;console.log("‚öôÔ∏è Auth state changed:",e,((o=t==null?void 0:t.user)==null?void 0:o.email)||"no user"),console.log("SIGNED_IN event, user:",t==null?void 0:t.user,"at",performance.now()),e==="SIGNED_IN"&&(t!=null&&t.user)&&(console.log("‚úÖ User signed in:",t.user.email),window.appInitialized=!1,b==null||b(),await L(t.user),window.appInitialized=!0,setTimeout(oe,1e3)),e==="SIGNED_OUT"&&(console.log(" User signed out ‚Äî resetting app"),window.appInitialized=!1,U==null||U(null),b==null||b(),window.currentAudio&&(window.currentAudio.pause(),window.currentAudio=null),window.isPlaying=!1,window.location.pathname.includes("index.html")||(window.location.href="/index.html"))});function Ue(e){e==="home"&&(window.location.href="/player.html")}window.currentPlaylist=g;window.currentTrackIndex=T;window.isShuffling=y;window.shuffleOrder=A;window.repeatMode=k;window.uploadTrack=async function(){const e=document.getElementById("trackFile"),t=document.getElementById("coverFileInput"),o=document.getElementById("trackTitleInput"),n=document.getElementById("trackArtistInput"),r=e.files[0],a=t.files[0];if(!r){alert("Vui l√≤ng ch·ªçn m·ªôt file nh·∫°c.");return}const{data:i,error:l}=await c.auth.getUser();if(l||!i.user){alert("L·ªói x√°c th·ª±c: Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.");return}const d=i.user.id;let u=null;try{if(a){console.log(`B·∫Øt ƒë·∫ßu t·∫£i ·∫£nh b√¨a: ${a.name}`);const ie=a.name.split(".").pop(),G=`${d}/${Date.now()}_cover.${ie}`,{error:j}=await c.storage.from("cover").upload(G,a);if(j)throw new Error(`L·ªói t·∫£i ·∫£nh b√¨a: ${j.message}`);const{data:le}=c.storage.from("cover").getPublicUrl(G);u=le.publicUrl}console.log(`B·∫Øt ƒë·∫ßu t·∫£i file nh·∫°c: ${r.name}`);const w=r.name.split(".").pop(),f=`${d}/${Date.now()}.${w}`,{error:p}=await c.storage.from("music-files").upload(f,r);if(p)throw new Error(`L·ªói t·∫£i file nh·∫°c: ${p.message}`);const{data:E}=c.storage.from("music-files").getPublicUrl(f),S=E.publicUrl,M={user_id:d,title:o.value||r.name.replace(`.${w}`,""),artist:n.value||"Unknown Artist",file_url:S,cover_url:u,uploaded_at:new Date().toISOString()},{error:K}=await c.from("tracks").insert([M]);if(K)throw new Error(`L·ªói l∆∞u DB: ${K.message}`);e.value="",t&&(t.value=""),o.value="",n.value="",window.switchTab&&window.switchTab("uploads"),window.cachedMyUploads&&(window.cachedMyUploads=null,console.log("Cache uploads cleared after successful upload")),window.loadMyUploads&&(window.loadMyUploads(!0),console.log("Force refreshed uploads after upload"))}catch(w){console.error("L·ªói khi upload:",w),alert(`L·ªói khi t·∫£i l√™n: ${w.message}`)}};window.switchTab=function(e,t=null){const o=document.querySelectorAll("#mainContentArea .main-section"),n=document.querySelectorAll(".sidebar-left .menu-item");let r=!1;const a=e+"-section";if(o.forEach(i=>{i.id===a?(i.style.display="block",r=!0):i.style.display="none"}),!r){console.warn(`Section "${a}" kh√¥ng t·ªìn t·∫°i trong v√πng ch·ª©a n·ªôi dung.`);return}e==="detail-playlist"&&t?window.loadDetailPlaylist?window.loadDetailPlaylist(t):console.error("H√†m loadDetailPlaylist kh√¥ng t·ªìn t·∫°i"):e==="uploads"&&window.loadMyUploads?window.loadMyUploads(!0):e==="recommend"&&window.renderRecommendations&&window.renderRecommendations(),n.forEach(i=>{i.getAttribute("data-section")===e?i.classList.add("active"):i.classList.remove("active")})};if(window.location.hostname==="localhost"){const e="?v="+Date.now();document.querySelectorAll('script[type="module"]').forEach(t=>{t.src.includes("/scripts/")&&(t.src=t.src.split("?")[0]+e)})}
